"use strict";
/**
 * Functionality to map the "flat" categories model to a nested document
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeMongoMap = exports.unwindsForNonterminalArrays = exports.getShortProjectedName = exports.isNonObjectPath = exports.makeMongoNameLC = exports.makeCanonicPropertyName = exports.getFirstSegment = exports.makeCategoryPath = exports.getMemberByPath = exports.findEschemaPropForCategory = exports.collectCategories = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('mongomap');
const process = require("process");
const _ = require("lodash");
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function traverseExecutingContext(obj, context) {
    _.forIn(obj, function (val, key) {
        // console.log(key + " -> " + val + " ");
        context.visit(obj, key, val);
        if (_.isArray(val)) {
            context.enterArray(key, val);
            val.forEach(function (el) {
                if (_.isObject(el)) {
                    traverseExecutingContext(el, context);
                }
            });
            context.leaveArray(key, val);
            // console.log('leaving array key' + key  + " " + JSON.stringify(val));
        }
        else if (_.isObject(val)) {
            //  if( _.isArray(val) && _.isObject(val)) {
            //&&      console.log('ABCXASDFS');
            //  };
            //   console.log('is also object' + JSON.stringify(val));
            context.enterObject(key, val);
            traverseExecutingContext(val, context);
            context.leaveObject(key, val);
        }
    });
}
function collectCategories(eSchemaProps) {
    var oContext = {
        res: {},
        plainPath: [],
        currentPath: [],
        enterObject: function (key, val) {
            this.currentPath.push(key);
            this.plainPath.push(key);
        },
        visit: function (obj, key, val) {
            if (key === '_m_category') {
                this.res[val] = {
                    paths: this.currentPath.slice(),
                    fullpath: this.plainPath.join('.')
                };
            }
        },
        leaveObject: function (key, val) {
            this.currentPath.pop();
            this.plainPath.pop();
        },
        enterArray: function (key, val) {
            this.enterObject(key, val);
            this.currentPath.push('[]');
        },
        leaveArray: function (key, val) {
            this.leaveObject(key, val);
            this.currentPath.pop();
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return oContext.res;
}
exports.collectCategories = collectCategories;
function findEschemaPropForCategory(eSchemaProps, category) {
    var prop = findEschemaPropForCategoryInt(eSchemaProps, category);
    if (prop._m_category != category) {
        throw new Error("Mismatch between category and prop " + category + " " + JSON.stringify(prop));
    }
    return prop;
}
exports.findEschemaPropForCategory = findEschemaPropForCategory;
function unwrapArrayOne(a) {
    if (_.isArray(a) && a.length == 1) {
        return a[0];
    }
    return a;
}
function findEschemaPropForCategoryInt(eSchemaProps, category) {
    var propName = makeCanonicPropertyName(category);
    var direct = eSchemaProps[propName];
    // todo: there is an ambiguity between 
    //  "category_synonyms" : [{ "type" : "String" , "_m_category":"category_synonyms"}]
    // and 
    //  "category_synonyms" : { "type" : ["String"] , "_m_category":"category_synonyms"}
    // see e.g. sendertyp , see also the spurious Items type for standorg 
    if (direct) {
        return unwrapArrayOne(direct);
    }
    var res = { r: undefined };
    var oContext = {
        enterObject: function (key, val) {
        },
        visit: function (obj, key, val) {
            if ((_.isObject(val) || _.isArray(val)) && propName == key) {
                if (res.r) {
                    throw new Error("Duplicate property " + propName + " " + JSON.stringify(res.r) + " now " + JSON.stringify(val));
                }
                console.log('found prop ' + JSON.stringify(res.r));
                res.r = unwrapArrayOne(val);
            }
        },
        leaveObject: function (key, val) {
        },
        enterArray: function (key, val) {
        },
        leaveArray: function (key, val) {
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return res.r;
}
/**
 * Given a record and a paths expression, return
 * the value (string or array) which represents this path
 * Note that a trailing array is not expanded,
 * @param rec
 * @param paths
 */
function getMemberByPath(rec, paths) {
    var root = rec;
    var res = paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            return prev[segment];
        }
        else {
            if (index === (paths.length - 1)) {
                return prev;
            }
            if (_.isArray(prev)) {
                if (prev.length > 1) {
                    throw Error('cannot flatten more than one record ');
                }
                return prev[0];
            }
            else {
                return prev;
            }
        }
    }, rec);
    debuglog(() => ` herer result ` + res);
    return res;
}
exports.getMemberByPath = getMemberByPath;
function constructPath(paths, len) {
    return paths.slice(0, len).filter(seg => seg !== '[]').join('.');
}
/**
 * return a category
 * @param mongoMap
 * @param cat a category
 * @return the constructed path, without any preceding $
 */
function makeCategoryPath(mongoMap, category) {
    return mongoMap[category].fullpath;
}
exports.makeCategoryPath = makeCategoryPath;
/**
 * Given a segment path, return the
 * @param paths
 */
function getFirstSegment(paths) {
    if (paths[0] === '[]' || paths.length === 0) {
        throw new Error('did not expect a full array');
    }
    return paths[0];
}
exports.getFirstSegment = getFirstSegment;
function makeCanonicPropertyName(category) {
    // no lowercasing!
    return category.replace(/[^a-zA-Z0-9]/g, '_');
}
exports.makeCanonicPropertyName = makeCanonicPropertyName;
function makeMongoNameLC(s) {
    return s.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
}
exports.makeMongoNameLC = makeMongoNameLC;
function isNonObjectPath(mongoMap, category) {
    return mongoMap[category].fullpath.indexOf(".") < 0;
}
exports.isNonObjectPath = isNonObjectPath;
function getShortProjectedName(mongoMap, category) {
    if (isNonObjectPath(mongoMap, category)) {
        return mongoMap[category].fullpath;
    }
    return makeMongoNameLC(category);
}
exports.getShortProjectedName = getShortProjectedName;
getShortProjectedName;
function unwindsForNonterminalArrays(mongoMap) {
    var paths = Object.keys(mongoMap).map(key => mongoMap[key].paths);
    var res = [];
    var seenAccess = {};
    return paths.reduce((prev, path) => {
        var prefix = '';
        return path.reduce((prev, segment, index) => {
            if (path.length - 1 !== index) {
                // last segment never of interest, even if []
                if (segment === '[]') {
                    var expandPath = '$' + constructPath(path, index);
                    if (!seenAccess[expandPath]) {
                        seenAccess[expandPath] = true;
                        prev.push({
                            $unwind: {
                                path: expandPath,
                                preserveNullAndEmptyArrays: true
                            }
                        });
                    }
                }
                return prev;
            }
            return prev;
        }, prev);
    }, res);
}
exports.unwindsForNonterminalArrays = unwindsForNonterminalArrays;
function makeMongoMap(oDoc, eSchema) {
    var oMongoMap = {};
    debuglog(() => 'creating mongomap for ' + JSON.stringify(eSchema.modelname, undefined, 2) + ' and ' + oDoc.modelname);
    debuglog(() => 'creating mongomap for doc ' + JSON.stringify(oDoc, undefined, 2));
    debuglog(() => 'colleting from eSchema.props' + JSON.stringify(eSchema.props, undefined, 2));
    var res = collectCategories(eSchema.props);
    oDoc._categories.forEach(cat => {
        // cross check
        if (!res[cat.category]) {
            console.log('here present keys' + Object.keys(res).sort().join("; "));
            console.log(`category ${cat.category} is not in eSchema`); // + JSON.stringify(eSchema,undefined,2)
            console.log(`document has ` + oDoc._categories.map(cat => cat.category).join('; '));
            //process.exit(-1);
            console.log(`category "${cat.category}" is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + "=====Schema:\n" + JSON.stringify(eSchema, undefined, 2).substring(0, 400)
                + "\n========oDoc: \n" + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
            process.exit(-1);
            throw new Error(`category ${cat.category} is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + JSON.stringify(eSchema, undefined, 2).substring(0, 200)
                + "\n=========== " + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
        }
    });
    return res;
}
exports.makeMongoMap = makeMongoMap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb25nb21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7O0FBR0gsb0NBQW9DO0FBQ3BDLGdDQUFnQztBQUVoQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7QUFhakMsbUNBQW1DO0FBQ25DLDRCQUE0QjtBQUc1Qjs7R0FFRztBQUNILElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSx1Q0FBdUMsQ0FBQztBQUc1RixTQUFTLHdCQUF3QixDQUFDLEdBQUcsRUFBRSxPQUFPO0lBQzFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7UUFDM0IseUNBQXlDO1FBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFTLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtvQkFDaEIsd0JBQXdCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUN6QztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0IsdUVBQXVFO1NBQ3pFO2FBQ0ksSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLDRDQUE0QztZQUM1QyxtQ0FBbUM7WUFDbkMsTUFBTTtZQUNQLHlEQUF5RDtZQUN0RCxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FB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QztJQUNILE9BQU8sR0FBRyxDQUFDO0FBQ2YsQ0FBQztBQXZCRCxvQ0F1QkMiLCJmaWxlIjoibW9kZWwvbW9uZ29tYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSB0byBtYXAgdGhlIFwiZmxhdFwiIGNhdGVnb3JpZXMgbW9kZWwgdG8gYSBuZXN0ZWQgZG9jdW1lbnRcclxuICpcclxuICogQGZpbGVcclxuICovXHJcblxyXG5cclxuLy9pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnZic7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9uZ29tYXAnKTtcclxuXHJcbmltcG9ydCAqIGFzIElTY2hlbWEgZnJvbSAnLi4vbW9kZWxsb2FkL3NjaGVtYWxvYWQnO1xyXG4vL2NvbnN0IGxvYWRsb2cgPSBsb2dnZXIubG9nZ2VyKCdtb2RlbGxvYWQnLCAnJyk7XHJcblxyXG5pbXBvcnQgKiAgYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL3J1bGUnO1xyXG4vL2ltcG9ydCAqIGFzIFRvb2xzIGZyb20gJy4uL21hdGNoL3Rvb2xzJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBNZXRhIGZyb20gJy4vbWV0YSc7XHJcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJ2Fib3RfdXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBDaXJjdWxhclNlciBmcm9tICdhYm90X3V0aWxzJztcclxuaW1wb3J0ICogYXMgRGlzdGFuY2UgZnJvbSAnYWJvdF9zdHJpbmdkaXN0JztcclxuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5cclxudHlwZSBDYXRNb25nb01hcCA9IElNYXRjaC5DYXRNb25nb01hcDtcclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBlbnZNb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwibm9kZV9tb2R1bGVzL2Fib3RfdGVzdG1vZGVsL3Rlc3Rtb2RlbFwiO1xyXG5cclxuXHJcbmZ1bmN0aW9uIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChvYmosIGNvbnRleHQpIHtcclxuICAgIF8uZm9ySW4ob2JqLCBmdW5jdGlvbiAodmFsLCBrZXkpIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhrZXkgKyBcIiAtPiBcIiArIHZhbCArIFwiIFwiKTtcclxuICAgICAgICBjb250ZXh0LnZpc2l0KG9iaixrZXksIHZhbCk7XHJcbiAgICAgICAgaWYgKF8uaXNBcnJheSh2YWwpKSB7XHJcbiAgICAgICAgICAgIGNvbnRleHQuZW50ZXJBcnJheShrZXksdmFsKTtcclxuICAgICAgICAgICAgdmFsLmZvckVhY2goZnVuY3Rpb24oZWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGVsKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChlbCwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjb250ZXh0LmxlYXZlQXJyYXkoa2V5LHZhbCk7XHJcbiAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xlYXZpbmcgYXJyYXkga2V5JyArIGtleSAgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KHZhbCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChfLmlzT2JqZWN0KHZhbCkpIHtcclxuICAgICAgICAgIC8vICBpZiggXy5pc0FycmF5KHZhbCkgJiYgXy5pc09iamVjdCh2YWwpKSB7XHJcbiAgICAgICAgICAvLyYmICAgICAgY29uc29sZS5sb2coJ0FCQ1hBU0RGUycpO1xyXG4gICAgICAgICAgLy8gIH07XHJcbiAgICAgICAgIC8vICAgY29uc29sZS5sb2coJ2lzIGFsc28gb2JqZWN0JyArIEpTT04uc3RyaW5naWZ5KHZhbCkpO1xyXG4gICAgICAgICAgICBjb250ZXh0LmVudGVyT2JqZWN0KGtleSwgdmFsKTtcclxuICAgICAgICAgICAgdHJhdmVyc2VFeGVjdXRpbmdDb250ZXh0KHZhbCxjb250ZXh0KTtcclxuICAgICAgICAgICAgY29udGV4dC5sZWF2ZU9iamVjdChrZXksdmFsKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbGxlY3RDYXRlZ29yaWVzKGVTY2hlbWFQcm9wcyA6IGFueSkge1xyXG4gICAgdmFyIG9Db250ZXh0ID0ge1xyXG4gICAgICAgIHJlcyA6IHt9IGFzIENhdE1vbmdvTWFwLFxyXG4gICAgICAgIHBsYWluUGF0aCA6IFtdLFxyXG4gICAgICAgIGN1cnJlbnRQYXRoIDogW10sXHJcbiAgICAgICAgZW50ZXJPYmplY3QgOiBmdW5jdGlvbihrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgICAgIHRoaXMucGxhaW5QYXRoLnB1c2goa2V5KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHZpc2l0OiBmdW5jdGlvbihvYmogOiBhbnksIGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICBpZihrZXkgPT09ICdfbV9jYXRlZ29yeScpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzW3ZhbF0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aHMgOiB0aGlzLmN1cnJlbnRQYXRoLnNsaWNlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgZnVsbHBhdGggOiB0aGlzLnBsYWluUGF0aC5qb2luKCcuJylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGVhdmVPYmplY3QgOiBmdW5jdGlvbihrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGF0aC5wb3AoKTtcclxuICAgICAgICAgICAgdGhpcy5wbGFpblBhdGgucG9wKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnRlckFycmF5IDogZnVuY3Rpb24oa2V5IDogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICB0aGlzLmVudGVyT2JqZWN0KGtleSwgdmFsKTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGF0aC5wdXNoKCdbXScpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGVhdmVBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5sZWF2ZU9iamVjdChrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucG9wKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdHJhdmVyc2VFeGVjdXRpbmdDb250ZXh0KGVTY2hlbWFQcm9wcywgb0NvbnRleHQgKTtcclxuICAgIHJldHVybiBvQ29udGV4dC5yZXM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEVzY2hlbWFQcm9wRm9yQ2F0ZWdvcnkoZVNjaGVtYVByb3BzIDogYW55LCBjYXRlZ29yeSA6IHN0cmluZykgOiBhbnkge1xyXG4gICAgdmFyIHByb3AgPSBmaW5kRXNjaGVtYVByb3BGb3JDYXRlZ29yeUludChlU2NoZW1hUHJvcHMsY2F0ZWdvcnkpO1xyXG4gICAgaWYgKCBwcm9wLl9tX2NhdGVnb3J5ICE9IGNhdGVnb3J5KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzbWF0Y2ggYmV0d2VlbiBjYXRlZ29yeSBhbmQgcHJvcCBcIiArIGNhdGVnb3J5ICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJvcDtcclxufVxyXG5cclxuZnVuY3Rpb24gdW53cmFwQXJyYXlPbmUoYTogYW55KSA6IGFueSB7XHJcbiAgICBpZiAoIF8uaXNBcnJheShhKSAmJiBhLmxlbmd0aCA9PSAxICkge1xyXG4gICAgICAgIHJldHVybiBhWzBdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGE7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbmRFc2NoZW1hUHJvcEZvckNhdGVnb3J5SW50KGVTY2hlbWFQcm9wcyA6IGFueSwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogYW55IHtcclxuICAgIHZhciBwcm9wTmFtZSA9IG1ha2VDYW5vbmljUHJvcGVydHlOYW1lKGNhdGVnb3J5KTtcclxuICAgIHZhciBkaXJlY3QgPSBlU2NoZW1hUHJvcHNbcHJvcE5hbWVdO1xyXG4gICAgLy8gdG9kbzogdGhlcmUgaXMgYW4gYW1iaWd1aXR5IGJldHdlZW4gXHJcbiAgICAvLyAgXCJjYXRlZ29yeV9zeW5vbnltc1wiIDogW3sgXCJ0eXBlXCIgOiBcIlN0cmluZ1wiICwgXCJfbV9jYXRlZ29yeVwiOlwiY2F0ZWdvcnlfc3lub255bXNcIn1dXHJcbiAgICAvLyBhbmQgXHJcbiAgICAvLyAgXCJjYXRlZ29yeV9zeW5vbnltc1wiIDogeyBcInR5cGVcIiA6IFtcIlN0cmluZ1wiXSAsIFwiX21fY2F0ZWdvcnlcIjpcImNhdGVnb3J5X3N5bm9ueW1zXCJ9XHJcbiAgICAvLyBzZWUgZS5nLiBzZW5kZXJ0eXAgLCBzZWUgYWxzbyB0aGUgc3B1cmlvdXMgSXRlbXMgdHlwZSBmb3Igc3RhbmRvcmcgXHJcbiAgICBpZiAoIGRpcmVjdCApIHtcclxuICAgICAgIHJldHVybiB1bndyYXBBcnJheU9uZShkaXJlY3QpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlcyA9IHsgcjogdW5kZWZpbmVkIH07XHJcbiAgICB2YXIgb0NvbnRleHQgPSB7XHJcbiAgICAgICAgZW50ZXJPYmplY3QgOiBmdW5jdGlvbihrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHZpc2l0OiBmdW5jdGlvbihvYmogOiBhbnksIGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICBpZiAoIChfLmlzT2JqZWN0KHZhbCkgfHwgXy5pc0FycmF5KHZhbCkpICYmIHByb3BOYW1lID09IGtleSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5yICkgIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEdXBsaWNhdGUgcHJvcGVydHkgXCIgKyBwcm9wTmFtZSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkocmVzLnIpICsgXCIgbm93IFwiICsgSlNPTi5zdHJpbmdpZnkodmFsKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZm91bmQgcHJvcCAnICsgSlNPTi5zdHJpbmdpZnkocmVzLnIpKTtcclxuICAgICAgICAgICAgICAgIHJlcy5yID0gIHVud3JhcEFycmF5T25lKHZhbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnRlckFycmF5IDogZnVuY3Rpb24oa2V5IDogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGVhdmVBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQoZVNjaGVtYVByb3BzLCBvQ29udGV4dCApO1xyXG4gICAgcmV0dXJuIHJlcy5yO1xyXG59XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiBHaXZlbiBhIHJlY29yZCBhbmQgYSBwYXRocyBleHByZXNzaW9uLCByZXR1cm5cclxuICogdGhlIHZhbHVlIChzdHJpbmcgb3IgYXJyYXkpIHdoaWNoIHJlcHJlc2VudHMgdGhpcyBwYXRoXHJcbiAqIE5vdGUgdGhhdCBhIHRyYWlsaW5nIGFycmF5IGlzIG5vdCBleHBhbmRlZCxcclxuICogQHBhcmFtIHJlY1xyXG4gKiBAcGFyYW0gcGF0aHNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRNZW1iZXJCeVBhdGgocmVjIDogYW55LCBwYXRoczogc3RyaW5nW10pICA6IGFueSB7XHJcbiAgICB2YXIgcm9vdCA9IHJlYztcclxuICAgIHZhciByZXMgPSBwYXRocy5yZWR1Y2UoIChwcmV2LCBzZWdtZW50LGluZGV4KSA9PiB7XHJcbiAgICAgICAgZGVidWdsb2coKCk9PiBgYXQgaW5kZXggJHtpbmRleH0gc2VnbWVudCAke3NlZ21lbnR9IG9uICR7SlNPTi5zdHJpbmdpZnkocHJldil9YCk7XHJcbiAgICAgICAgaWYocHJldiA9PT0gdW5kZWZpbmVkIHx8IHByZXYgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYoc2VnbWVudCAhPT0gXCJbXVwiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmV2W3NlZ21lbnRdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmKGluZGV4ID09PSAocGF0aHMubGVuZ3RoIC0gMSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKF8uaXNBcnJheShwcmV2KSkge1xyXG4gICAgICAgICAgICAgICAgaWYocHJldi5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ2Nhbm5vdCBmbGF0dGVuIG1vcmUgdGhhbiBvbmUgcmVjb3JkICcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXZbMF07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sIHJlYyk7XHJcbiAgICBkZWJ1Z2xvZygoKT0+IGAgaGVyZXIgcmVzdWx0IGAgKyByZXMpO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGNvbnN0cnVjdFBhdGgocGF0aHMgOiBzdHJpbmcgW10sIGxlbiA6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIHBhdGhzLnNsaWNlKDAsIGxlbikuZmlsdGVyKHNlZyA9PiBzZWcgIT09ICdbXScpLmpvaW4oJy4nKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiByZXR1cm4gYSBjYXRlZ29yeVxyXG4gKiBAcGFyYW0gbW9uZ29NYXBcclxuICogQHBhcmFtIGNhdCBhIGNhdGVnb3J5XHJcbiAqIEByZXR1cm4gdGhlIGNvbnN0cnVjdGVkIHBhdGgsIHdpdGhvdXQgYW55IHByZWNlZGluZyAkXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbWFrZUNhdGVnb3J5UGF0aChtb25nb01hcDogSU1hdGNoLkNhdE1vbmdvTWFwICwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogc3RyaW5nIHtcclxuICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGg7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHaXZlbiBhIHNlZ21lbnQgcGF0aCwgcmV0dXJuIHRoZVxyXG4gKiBAcGFyYW0gcGF0aHNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGaXJzdFNlZ21lbnQocGF0aHMgOiBzdHJpbmdbXSApIDogc3RyaW5nIHtcclxuICAgIGlmKHBhdGhzWzBdID09PSAnW10nICB8fCBwYXRocy5sZW5ndGggPT09IDApICB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdkaWQgbm90IGV4cGVjdCBhIGZ1bGwgYXJyYXknKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRoc1swXTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VDYW5vbmljUHJvcGVydHlOYW1lKGNhdGVnb3J5IDogc3RyaW5nICkgOiBzdHJpbmcge1xyXG4gICAgLy8gbm8gbG93ZXJjYXNpbmchXHJcbiAgICByZXR1cm4gY2F0ZWdvcnkucmVwbGFjZSgvW15hLXpBLVowLTldL2csJ18nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VNb25nb05hbWVMQyhzIDogc3RyaW5nKSA6IHN0cmluZyB7XHJcbiAgcmV0dXJuIHMucmVwbGFjZSgvW15hLXpBLVowLTldL2csJ18nKS50b0xvd2VyQ2FzZSgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNOb25PYmplY3RQYXRoKG1vbmdvTWFwIDogSU1hdGNoLkNhdE1vbmdvTWFwLCBjYXRlZ29yeSA6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGguaW5kZXhPZihcIi5cIikgPCAwO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2hvcnRQcm9qZWN0ZWROYW1lKG1vbmdvTWFwOiBJTWF0Y2guQ2F0TW9uZ29NYXAsIGNhdGVnb3J5IDogc3RyaW5nKSA6IHN0cmluZyB7XHJcbiAgICBpZihpc05vbk9iamVjdFBhdGgobW9uZ29NYXAsIGNhdGVnb3J5KSkge1xyXG4gICAgICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbWFrZU1vbmdvTmFtZUxDKGNhdGVnb3J5KTtcclxufVxyXG5cclxuZ2V0U2hvcnRQcm9qZWN0ZWROYW1lXHJcblxyXG4gZXhwb3J0IGZ1bmN0aW9uIHVud2luZHNGb3JOb250ZXJtaW5hbEFycmF5cyhtb25nb01hcCA6IElNYXRjaC5DYXRNb25nb01hcCkgOiBhbnlbXSB7XHJcbiAgICAgdmFyIHBhdGhzID0gT2JqZWN0LmtleXMobW9uZ29NYXApLm1hcChrZXkgPT4gIG1vbmdvTWFwW2tleV0ucGF0aHMpO1xyXG4gICAgIHZhciByZXMgPSBbXTtcclxuICAgICB2YXIgc2VlbkFjY2VzcyA9IHt9IGFzIHsgW2tleTpzdHJpbmddIDogYm9vbGVhbn07XHJcbiAgICAgcmV0dXJuIHBhdGhzLnJlZHVjZSggKHByZXYsIHBhdGgpID0+IHtcclxuICAgICAgICB2YXIgcHJlZml4ID0gJyc7XHJcbiAgICAgICAgcmV0dXJuIHBhdGgucmVkdWNlKCAocHJldiwgc2VnbWVudCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgaWYocGF0aC5sZW5ndGggLSAxICAhPT0gaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgIC8vIGxhc3Qgc2VnbWVudCBuZXZlciBvZiBpbnRlcmVzdCwgZXZlbiBpZiBbXVxyXG4gICAgICAgICAgICAgICAgaWYoc2VnbWVudCA9PT0nW10nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cGFuZFBhdGggPSAnJCcgKyBjb25zdHJ1Y3RQYXRoKHBhdGgsaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZWVuQWNjZXNzW2V4cGFuZFBhdGhdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZW5BY2Nlc3NbZXhwYW5kUGF0aF0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHVud2luZCA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoIDogZXhwYW5kUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXJ2ZU51bGxBbmRFbXB0eUFycmF5cyA6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgfSwgcHJldik7XHJcbiAgICAgfSwgcmVzKTtcclxuIH1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlTW9uZ29NYXAob0RvYyA6IElTY2hlbWEuSU1vZGVsRG9jLCBlU2NoZW1hIDogSVNjaGVtYS5JRXh0ZW5kZWRTY2hlbWEgKSA6IElNYXRjaC5DYXRNb25nb01hcCB7XHJcbiAgICB2YXIgb01vbmdvTWFwID0ge30gYXMgQ2F0TW9uZ29NYXA7XHJcbiAgICBkZWJ1Z2xvZyggKCkgPT4gJ2NyZWF0aW5nIG1vbmdvbWFwIGZvciAnICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYS5tb2RlbG5hbWUsIHVuZGVmaW5lZCwgMikgKyAnIGFuZCAnICsgb0RvYy5tb2RlbG5hbWUgKTtcclxuICAgIGRlYnVnbG9nKCAoKSA9PidjcmVhdGluZyBtb25nb21hcCBmb3IgZG9jICcgKyBKU09OLnN0cmluZ2lmeShvRG9jLCB1bmRlZmluZWQsIDIpKTtcclxuICAgIGRlYnVnbG9nKCAoKSA9Pidjb2xsZXRpbmcgZnJvbSBlU2NoZW1hLnByb3BzJyArIEpTT04uc3RyaW5naWZ5KGVTY2hlbWEucHJvcHMsdW5kZWZpbmVkLDIpKTtcclxuICAgIHZhciByZXMgPSBjb2xsZWN0Q2F0ZWdvcmllcyhlU2NoZW1hLnByb3BzKTtcclxuICAgIG9Eb2MuX2NhdGVnb3JpZXMuZm9yRWFjaChjYXQgPT4ge1xyXG4gICAgICAgIC8vIGNyb3NzIGNoZWNrXHJcbiAgICAgICAgaWYoIXJlc1tjYXQuY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdoZXJlIHByZXNlbnQga2V5cycgKyBPYmplY3Qua2V5cyhyZXMpLnNvcnQoKS5qb2luKFwiOyBcIikpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgY2F0ZWdvcnkgJHtjYXQuY2F0ZWdvcnl9IGlzIG5vdCBpbiBlU2NoZW1hYCk7IC8vICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMilcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYGRvY3VtZW50IGhhcyBgKyBvRG9jLl9jYXRlZ29yaWVzLm1hcChjYXQgPT4gY2F0LmNhdGVnb3J5KS5qb2luKCc7ICcpKTtcclxuLy9wcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgIGNvbnNvbGUubG9nKGBjYXRlZ29yeSBcIiR7Y2F0LmNhdGVnb3J5fVwiIGlzIG5vdCBpbiBlU2NoZW1hIGZvciAke29Eb2MubW9kZWxuYW1lfSArICR7ZVNjaGVtYS5tb2RlbG5hbWV9IDogYFxyXG4gICAgICAgICAgICArIFwiPT09PT1TY2hlbWE6XFxuXCIrIEpTT04uc3RyaW5naWZ5KGVTY2hlbWEsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMClcclxuICAgICAgICAgICAgKyBcIlxcbj09PT09PT09b0RvYzogXFxuXCIgKyBKU09OLnN0cmluZ2lmeShvRG9jLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCw0MDApKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYXRlZ29yeSAke2NhdC5jYXRlZ29yeX0gaXMgbm90IGluIGVTY2hlbWEgZm9yICR7b0RvYy5tb2RlbG5hbWV9ICsgJHtlU2NoZW1hLm1vZGVsbmFtZX0gOiBgXHJcbiAgICAgICAgICAgICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMikuc3Vic3RyaW5nKDAsMjAwKVxyXG4gICAgICAgICAgICArIFwiXFxuPT09PT09PT09PT0gXCIgKyBKU09OLnN0cmluZ2lmeShvRG9jLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCw0MDApKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbiJdfQ==
