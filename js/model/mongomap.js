"use strict";
/**
 * Functionality to map the "flat" categories model to a nested document
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeMongoMap = exports.unwindsForNonterminalArrays = exports.getShortProjectedName = exports.isNonObjectPath = exports.makeMongoNameLC = exports.getFirstSegment = exports.makeCategoryPath = exports.getMemberByPath = exports.collectCategories = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('mongomap');
const process = require("process");
const _ = require("lodash");
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function traverseExecutingContext(obj, context) {
    _.forIn(obj, function (val, key) {
        // console.log(key + " -> " + val + " ");
        context.visit(obj, key, val);
        if (_.isArray(val)) {
            context.enterArray(key, val);
            val.forEach(function (el) {
                if (_.isObject(el)) {
                    traverseExecutingContext(el, context);
                }
            });
            context.leaveArray(key, val);
            // console.log('leaving array key' + key  + " " + JSON.stringify(val));
        }
        else if (_.isObject(val)) {
            //  if( _.isArray(val) && _.isObject(val)) {
            //&&      console.log('ABCXASDFS');
            //  };
            //   console.log('is also object' + JSON.stringify(val));
            context.enterObject(key, val);
            traverseExecutingContext(val, context);
            context.leaveObject(key, val);
        }
    });
}
function collectCategories(eSchemaProps) {
    var oContext = {
        res: {},
        plainPath: [],
        currentPath: [],
        enterObject: function (key, val) {
            this.currentPath.push(key);
            this.plainPath.push(key);
        },
        visit: function (obj, key, val) {
            if (key === '_m_category') {
                this.res[val] = {
                    paths: this.currentPath.slice(),
                    fullpath: this.plainPath.join('.')
                };
            }
        },
        leaveObject: function (key, val) {
            this.currentPath.pop();
            this.plainPath.pop();
        },
        enterArray: function (key, val) {
            this.enterObject(key, val);
            this.currentPath.push('[]');
        },
        leaveArray: function (key, val) {
            this.leaveObject(key, val);
            this.currentPath.pop();
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return oContext.res;
}
exports.collectCategories = collectCategories;
/**
 * Given a record and a paths expression, return
 * the value (string or array) which represents this path
 * Note that a trailing array is not expanded,
 * @param rec
 * @param paths
 */
function getMemberByPath(rec, paths) {
    var root = rec;
    var res = paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            return prev[segment];
        }
        else {
            if (index === (paths.length - 1)) {
                return prev;
            }
            if (_.isArray(prev)) {
                if (prev.length > 1) {
                    throw Error('cannot flatten more than one record ');
                }
                return prev[0];
            }
            else {
                return prev;
            }
        }
    }, rec);
    debuglog(() => ` herer result ` + res);
    return res;
}
exports.getMemberByPath = getMemberByPath;
function constructPath(paths, len) {
    return paths.slice(0, len).filter(seg => seg !== '[]').join('.');
}
/**
 * return a category
 * @param mongoMap
 * @param cat a category
 * @return the constructed path, without any preceding $
 */
function makeCategoryPath(mongoMap, category) {
    return mongoMap[category].fullpath;
}
exports.makeCategoryPath = makeCategoryPath;
/**
 * Given a segment path, return the
 * @param paths
 */
function getFirstSegment(paths) {
    if (paths[0] === '[]' || paths.length === 0) {
        throw new Error('did not expect a full array');
    }
    return paths[0];
}
exports.getFirstSegment = getFirstSegment;
function makeMongoNameLC(s) {
    return s.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
}
exports.makeMongoNameLC = makeMongoNameLC;
function isNonObjectPath(mongoMap, category) {
    return mongoMap[category].fullpath.indexOf(".") < 0;
}
exports.isNonObjectPath = isNonObjectPath;
function getShortProjectedName(mongoMap, category) {
    if (isNonObjectPath(mongoMap, category)) {
        return mongoMap[category].fullpath;
    }
    return makeMongoNameLC(category);
}
exports.getShortProjectedName = getShortProjectedName;
getShortProjectedName;
function unwindsForNonterminalArrays(mongoMap) {
    var paths = Object.keys(mongoMap).map(key => mongoMap[key].paths);
    var res = [];
    var seenAccess = {};
    return paths.reduce((prev, path) => {
        var prefix = '';
        return path.reduce((prev, segment, index) => {
            if (path.length - 1 !== index) {
                // last segment never of interest, even if []
                if (segment === '[]') {
                    var expandPath = '$' + constructPath(path, index);
                    if (!seenAccess[expandPath]) {
                        seenAccess[expandPath] = true;
                        prev.push({
                            $unwind: {
                                path: expandPath,
                                preserveNullAndEmptyArrays: true
                            }
                        });
                    }
                }
                return prev;
            }
            return prev;
        }, prev);
    }, res);
}
exports.unwindsForNonterminalArrays = unwindsForNonterminalArrays;
function makeMongoMap(oDoc, eSchema) {
    var oMongoMap = {};
    debuglog(() => 'creating mongomap for ' + JSON.stringify(eSchema.modelname, undefined, 2) + ' and ' + oDoc.modelname);
    debuglog(() => 'creating mongomap for doc ' + JSON.stringify(oDoc, undefined, 2));
    debuglog(() => 'colleting from eSchema.props' + JSON.stringify(eSchema.props, undefined, 2));
    var res = collectCategories(eSchema.props);
    oDoc._categories.forEach(cat => {
        // cross check
        if (!res[cat.category]) {
            console.log('here present keys' + Object.keys(res).sort().join("; "));
            console.log(`category ${cat.category} is not in eSchema`); // + JSON.stringify(eSchema,undefined,2)
            console.log(`document has ` + oDoc._categories.map(cat => cat.category).join('; '));
            //process.exit(-1);
            console.log(`category "${cat.category}" is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + "=====Schema:\n" + JSON.stringify(eSchema, undefined, 2).substring(0, 400)
                + "\n========oDoc: \n" + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
            process.exit(-1);
            throw new Error(`category ${cat.category} is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + JSON.stringify(eSchema, undefined, 2).substring(0, 200)
                + "\n=========== " + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
        }
    });
    return res;
}
exports.makeMongoMap = makeMongoMap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb25nb21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7O0FBR0gsb0NBQW9DO0FBQ3BDLGdDQUFnQztBQUVoQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7QUFhakMsbUNBQW1DO0FBQ25DLDRCQUE0QjtBQUc1Qjs7R0FFRztBQUNILElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSx1Q0FBdUMsQ0FBQztBQUc1RixTQUFTLHdCQUF3QixDQUFDLEdBQUcsRUFBRSxPQUFPO0lBQzFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7UUFDM0IseUNBQXlDO1FBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFTLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtvQkFDaEIsd0JBQXdCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUN6QztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0IsdUVBQXVFO1NBQ3pFO2FBQ0ksSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLDRDQUE0QztZQUM1QyxtQ0FBbUM7WUFDbkMsTUFBTTtZQUNQLHlEQUF5RDtZQUN0RCxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FB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LENBQUMsU0FBUyxDQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzNFO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUF2QkQsb0NBdUJDIiwiZmlsZSI6Im1vZGVsL21vbmdvbWFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gbWFwIHRoZSBcImZsYXRcIiBjYXRlZ29yaWVzIG1vZGVsIHRvIGEgbmVzdGVkIGRvY3VtZW50XHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuXHJcbi8vaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Z2YnO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vbmdvbWFwJyk7XHJcblxyXG5pbXBvcnQgKiBhcyBJU2NoZW1hIGZyb20gJy4uL21vZGVsbG9hZC9zY2hlbWFsb2FkJztcclxuLy9jb25zdCBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9ydWxlJztcclxuLy9pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgTWV0YSBmcm9tICcuL21ldGEnO1xyXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICdhYm90X3V0aWxzJztcclxuaW1wb3J0ICogYXMgQ2lyY3VsYXJTZXIgZnJvbSAnYWJvdF91dGlscyc7XHJcbmltcG9ydCAqIGFzIERpc3RhbmNlIGZyb20gJ2Fib3Rfc3RyaW5nZGlzdCc7XHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuXHJcbnR5cGUgQ2F0TW9uZ29NYXAgPSBJTWF0Y2guQ2F0TW9uZ29NYXA7XHJcbi8qKlxyXG4gKiB0aGUgbW9kZWwgcGF0aCwgbWF5IGJlIGNvbnRyb2xsZWQgdmlhIGVudmlyb25tZW50IHZhcmlhYmxlXHJcbiAqL1xyXG52YXIgZW52TW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcIm5vZGVfbW9kdWxlcy9hYm90X3Rlc3Rtb2RlbC90ZXN0bW9kZWxcIjtcclxuXHJcblxyXG5mdW5jdGlvbiB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQob2JqLCBjb250ZXh0KSB7XHJcbiAgICBfLmZvckluKG9iaiwgZnVuY3Rpb24gKHZhbCwga2V5KSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coa2V5ICsgXCIgLT4gXCIgKyB2YWwgKyBcIiBcIik7XHJcbiAgICAgICAgY29udGV4dC52aXNpdChvYmosa2V5LCB2YWwpO1xyXG4gICAgICAgIGlmIChfLmlzQXJyYXkodmFsKSkge1xyXG4gICAgICAgICAgICBjb250ZXh0LmVudGVyQXJyYXkoa2V5LHZhbCk7XHJcbiAgICAgICAgICAgIHZhbC5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoXy5pc09iamVjdChlbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQoZWwsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY29udGV4dC5sZWF2ZUFycmF5KGtleSx2YWwpO1xyXG4gICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdsZWF2aW5nIGFycmF5IGtleScgKyBrZXkgICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeSh2YWwpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdCh2YWwpKSB7XHJcbiAgICAgICAgICAvLyAgaWYoIF8uaXNBcnJheSh2YWwpICYmIF8uaXNPYmplY3QodmFsKSkge1xyXG4gICAgICAgICAgLy8mJiAgICAgIGNvbnNvbGUubG9nKCdBQkNYQVNERlMnKTtcclxuICAgICAgICAgIC8vICB9O1xyXG4gICAgICAgICAvLyAgIGNvbnNvbGUubG9nKCdpcyBhbHNvIG9iamVjdCcgKyBKU09OLnN0cmluZ2lmeSh2YWwpKTtcclxuICAgICAgICAgICAgY29udGV4dC5lbnRlck9iamVjdChrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dCh2YWwsY29udGV4dCk7XHJcbiAgICAgICAgICAgIGNvbnRleHQubGVhdmVPYmplY3Qoa2V5LHZhbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb2xsZWN0Q2F0ZWdvcmllcyhlU2NoZW1hUHJvcHMgOiBhbnkpIHtcclxuICAgIHZhciBvQ29udGV4dCA9IHtcclxuICAgICAgICByZXMgOiB7fSBhcyBDYXRNb25nb01hcCxcclxuICAgICAgICBwbGFpblBhdGggOiBbXSxcclxuICAgICAgICBjdXJyZW50UGF0aCA6IFtdLFxyXG4gICAgICAgIGVudGVyT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucHVzaChrZXkpO1xyXG4gICAgICAgICAgICB0aGlzLnBsYWluUGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB2aXNpdDogZnVuY3Rpb24ob2JqIDogYW55LCBrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYoa2V5ID09PSAnX21fY2F0ZWdvcnknKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc1t2YWxdID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhdGhzIDogdGhpcy5jdXJyZW50UGF0aC5zbGljZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bGxwYXRoIDogdGhpcy5wbGFpblBhdGguam9pbignLicpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucG9wKCk7XHJcbiAgICAgICAgICAgIHRoaXMucGxhaW5QYXRoLnBvcCgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW50ZXJBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5lbnRlck9iamVjdChrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucHVzaCgnW10nKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlQXJyYXkgOiBmdW5jdGlvbihrZXkgOiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMubGVhdmVPYmplY3Qoa2V5LCB2YWwpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRQYXRoLnBvcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChlU2NoZW1hUHJvcHMsIG9Db250ZXh0ICk7XHJcbiAgICByZXR1cm4gb0NvbnRleHQucmVzO1xyXG59XHJcblxyXG4vKipcclxuICogR2l2ZW4gYSByZWNvcmQgYW5kIGEgcGF0aHMgZXhwcmVzc2lvbiwgcmV0dXJuXHJcbiAqIHRoZSB2YWx1ZSAoc3RyaW5nIG9yIGFycmF5KSB3aGljaCByZXByZXNlbnRzIHRoaXMgcGF0aFxyXG4gKiBOb3RlIHRoYXQgYSB0cmFpbGluZyBhcnJheSBpcyBub3QgZXhwYW5kZWQsXHJcbiAqIEBwYXJhbSByZWNcclxuICogQHBhcmFtIHBhdGhzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWVtYmVyQnlQYXRoKHJlYyA6IGFueSwgcGF0aHM6IHN0cmluZ1tdKSAgOiBhbnkge1xyXG4gICAgdmFyIHJvb3QgPSByZWM7XHJcbiAgICB2YXIgcmVzID0gcGF0aHMucmVkdWNlKCAocHJldiwgc2VnbWVudCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGRlYnVnbG9nKCgpPT4gYGF0IGluZGV4ICR7aW5kZXh9IHNlZ21lbnQgJHtzZWdtZW50fSBvbiAke0pTT04uc3RyaW5naWZ5KHByZXYpfWApO1xyXG4gICAgICAgIGlmKHByZXYgPT09IHVuZGVmaW5lZCB8fCBwcmV2ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHNlZ21lbnQgIT09IFwiW11cIikge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJldltzZWdtZW50XTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZihpbmRleCA9PT0gKHBhdGhzLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihfLmlzQXJyYXkocHJldikpIHtcclxuICAgICAgICAgICAgICAgIGlmKHByZXYubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdjYW5ub3QgZmxhdHRlbiBtb3JlIHRoYW4gb25lIHJlY29yZCAnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2WzBdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9LCByZWMpO1xyXG4gICAgZGVidWdsb2coKCk9PiBgIGhlcmVyIHJlc3VsdCBgICsgcmVzKTtcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBjb25zdHJ1Y3RQYXRoKHBhdGhzIDogc3RyaW5nIFtdLCBsZW4gOiBudW1iZXIpIHtcclxuICAgIHJldHVybiBwYXRocy5zbGljZSgwLCBsZW4pLmZpbHRlcihzZWcgPT4gc2VnICE9PSAnW10nKS5qb2luKCcuJyk7XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogcmV0dXJuIGEgY2F0ZWdvcnlcclxuICogQHBhcmFtIG1vbmdvTWFwXHJcbiAqIEBwYXJhbSBjYXQgYSBjYXRlZ29yeVxyXG4gKiBAcmV0dXJuIHRoZSBjb25zdHJ1Y3RlZCBwYXRoLCB3aXRob3V0IGFueSBwcmVjZWRpbmcgJFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VDYXRlZ29yeVBhdGgobW9uZ29NYXA6IElNYXRjaC5DYXRNb25nb01hcCAsIGNhdGVnb3J5IDogc3RyaW5nKSA6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gbW9uZ29NYXBbY2F0ZWdvcnldLmZ1bGxwYXRoO1xyXG59XHJcblxyXG4vKipcclxuICogR2l2ZW4gYSBzZWdtZW50IHBhdGgsIHJldHVybiB0aGVcclxuICogQHBhcmFtIHBhdGhzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0Rmlyc3RTZWdtZW50KHBhdGhzIDogc3RyaW5nW10gKSA6IHN0cmluZyB7XHJcbiAgICBpZihwYXRoc1swXSA9PT0gJ1tdJyAgfHwgcGF0aHMubGVuZ3RoID09PSAwKSAge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignZGlkIG5vdCBleHBlY3QgYSBmdWxsIGFycmF5Jyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aHNbMF07XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1vbmdvTmFtZUxDKHMgOiBzdHJpbmcpIDogc3RyaW5nIHtcclxuICByZXR1cm4gcy5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywnXycpLnRvTG93ZXJDYXNlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc05vbk9iamVjdFBhdGgobW9uZ29NYXAgOiBJTWF0Y2guQ2F0TW9uZ29NYXAsIGNhdGVnb3J5IDogc3RyaW5nKSA6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIG1vbmdvTWFwW2NhdGVnb3J5XS5mdWxscGF0aC5pbmRleE9mKFwiLlwiKSA8IDA7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTaG9ydFByb2plY3RlZE5hbWUobW9uZ29NYXA6IElNYXRjaC5DYXRNb25nb01hcCwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogc3RyaW5nIHtcclxuICAgIGlmKGlzTm9uT2JqZWN0UGF0aChtb25nb01hcCwgY2F0ZWdvcnkpKSB7XHJcbiAgICAgICAgcmV0dXJuIG1vbmdvTWFwW2NhdGVnb3J5XS5mdWxscGF0aDtcclxuICAgIH1cclxuICAgIHJldHVybiBtYWtlTW9uZ29OYW1lTEMoY2F0ZWdvcnkpO1xyXG59XHJcblxyXG5nZXRTaG9ydFByb2plY3RlZE5hbWVcclxuXHJcbiBleHBvcnQgZnVuY3Rpb24gdW53aW5kc0Zvck5vbnRlcm1pbmFsQXJyYXlzKG1vbmdvTWFwIDogSU1hdGNoLkNhdE1vbmdvTWFwKSA6IGFueVtdIHtcclxuICAgICB2YXIgcGF0aHMgPSBPYmplY3Qua2V5cyhtb25nb01hcCkubWFwKGtleSA9PiAgbW9uZ29NYXBba2V5XS5wYXRocyk7XHJcbiAgICAgdmFyIHJlcyA9IFtdO1xyXG4gICAgIHZhciBzZWVuQWNjZXNzID0ge30gYXMgeyBba2V5OnN0cmluZ10gOiBib29sZWFufTtcclxuICAgICByZXR1cm4gcGF0aHMucmVkdWNlKCAocHJldiwgcGF0aCkgPT4ge1xyXG4gICAgICAgIHZhciBwcmVmaXggPSAnJztcclxuICAgICAgICByZXR1cm4gcGF0aC5yZWR1Y2UoIChwcmV2LCBzZWdtZW50LCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICBpZihwYXRoLmxlbmd0aCAtIDEgICE9PSBpbmRleCkge1xyXG4gICAgICAgICAgICAgICAgLy8gbGFzdCBzZWdtZW50IG5ldmVyIG9mIGludGVyZXN0LCBldmVuIGlmIFtdXHJcbiAgICAgICAgICAgICAgICBpZihzZWdtZW50ID09PSdbXScpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZXhwYW5kUGF0aCA9ICckJyArIGNvbnN0cnVjdFBhdGgocGF0aCxpbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIXNlZW5BY2Nlc3NbZXhwYW5kUGF0aF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VlbkFjY2Vzc1tleHBhbmRQYXRoXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXYucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdW53aW5kIDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGggOiBleHBhbmRQYXRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlcnZlTnVsbEFuZEVtcHR5QXJyYXlzIDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICB9LCBwcmV2KTtcclxuICAgICB9LCByZXMpO1xyXG4gfVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VNb25nb01hcChvRG9jIDogSVNjaGVtYS5JTW9kZWxEb2MsIGVTY2hlbWEgOiBJU2NoZW1hLklFeHRlbmRlZFNjaGVtYSApIDogSU1hdGNoLkNhdE1vbmdvTWFwIHtcclxuICAgIHZhciBvTW9uZ29NYXAgPSB7fSBhcyBDYXRNb25nb01hcDtcclxuICAgIGRlYnVnbG9nKCAoKSA9PiAnY3JlYXRpbmcgbW9uZ29tYXAgZm9yICcgKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLm1vZGVsbmFtZSwgdW5kZWZpbmVkLCAyKSArICcgYW5kICcgKyBvRG9jLm1vZGVsbmFtZSApO1xyXG4gICAgZGVidWdsb2coICgpID0+J2NyZWF0aW5nIG1vbmdvbWFwIGZvciBkb2MgJyArIEpTT04uc3RyaW5naWZ5KG9Eb2MsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgZGVidWdsb2coICgpID0+J2NvbGxldGluZyBmcm9tIGVTY2hlbWEucHJvcHMnICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYS5wcm9wcyx1bmRlZmluZWQsMikpO1xyXG4gICAgdmFyIHJlcyA9IGNvbGxlY3RDYXRlZ29yaWVzKGVTY2hlbWEucHJvcHMpO1xyXG4gICAgb0RvYy5fY2F0ZWdvcmllcy5mb3JFYWNoKGNhdCA9PiB7XHJcbiAgICAgICAgLy8gY3Jvc3MgY2hlY2tcclxuICAgICAgICBpZighcmVzW2NhdC5jYXRlZ29yeV0pIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2hlcmUgcHJlc2VudCBrZXlzJyArIE9iamVjdC5rZXlzKHJlcykuc29ydCgpLmpvaW4oXCI7IFwiKSk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBjYXRlZ29yeSAke2NhdC5jYXRlZ29yeX0gaXMgbm90IGluIGVTY2hlbWFgKTsgLy8gKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLHVuZGVmaW5lZCwyKVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgZG9jdW1lbnQgaGFzIGArIG9Eb2MuX2NhdGVnb3JpZXMubWFwKGNhdCA9PiBjYXQuY2F0ZWdvcnkpLmpvaW4oJzsgJykpO1xyXG4vL3Byb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgY29uc29sZS5sb2coYGNhdGVnb3J5IFwiJHtjYXQuY2F0ZWdvcnl9XCIgaXMgbm90IGluIGVTY2hlbWEgZm9yICR7b0RvYy5tb2RlbG5hbWV9ICsgJHtlU2NoZW1hLm1vZGVsbmFtZX0gOiBgXHJcbiAgICAgICAgICAgICsgXCI9PT09PVNjaGVtYTpcXG5cIisgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMikuc3Vic3RyaW5nKDAsNDAwKVxyXG4gICAgICAgICAgICArIFwiXFxuPT09PT09PT1vRG9jOiBcXG5cIiArIEpTT04uc3RyaW5naWZ5KG9Eb2MsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMCkpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNhdGVnb3J5ICR7Y2F0LmNhdGVnb3J5fSBpcyBub3QgaW4gZVNjaGVtYSBmb3IgJHtvRG9jLm1vZGVsbmFtZX0gKyAke2VTY2hlbWEubW9kZWxuYW1lfSA6IGBcclxuICAgICAgICAgICAgKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCwyMDApXHJcbiAgICAgICAgICAgICsgXCJcXG49PT09PT09PT09PSBcIiArIEpTT04uc3RyaW5naWZ5KG9Eb2MsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMCkpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuIl19
