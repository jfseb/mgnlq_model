{"version":3,"sources":["/projects/nodejs/botbuilder/mgnlq_model/src//projects/nodejs/botbuilder/mgnlq_model/src/../src/modelload/schemaload.ts"],"names":[],"mappings":"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","file":"schemaload.js","sourcesContent":["/**\r\n * Functionality managing the match models\r\n *\r\n * @file\r\n */\r\n\r\n//import * as intf from 'constants';\r\nimport * as debug from 'debugf';\r\n\r\nvar debuglog = debug('schemaload');\r\n\r\n//const loadlog = logger.logger('modelload', '');\r\n\r\nimport *  as IMatch from '../match/ifmatch';\r\n//import * as InputFilterRules from '../match/rule';\r\n//import * as Tools from '../match/tools';\r\nimport * as fs from 'fs';\r\nimport * as Meta from '../model/meta';\r\nimport * as FUtils from '../model/model';\r\nimport * as Utils from 'abot_utils';\r\n//import * as CircularSer from 'abot_utils';\r\n//import * as Distance from 'abot_stringdist';\r\nimport * as process from 'process';\r\nimport * as _ from 'lodash';\r\nimport * as mongoose from 'mongoose';\r\n\r\n(mongoose as any).Promise = global.Promise;\r\n\r\n/**\r\n * WATCH out, this instruments mongoose!\r\n */\r\nrequire('mongoose-schema-jsonschema')(mongoose);\r\n/**\r\n * the model path, may be controlled via environment variable\r\n */\r\nvar envModelPath = process.env[\"ABOT_MODELPATH\"] || \"node_modules/abot_testmodel/testmodel\";\r\n\r\nexport function cmpTools(a: IMatch.ITool, b: IMatch.ITool) {\r\n  return a.name.localeCompare(b.name);\r\n}\r\n\r\n\r\ntype IModel = IMatch.IModel;\r\n\r\nconst ExtendedSchema_props = {\r\n    \"modelname\": {\r\n      \"type\": String,\r\n      \"trim\": true,\r\n      \"required\" : true\r\n    },\r\n    \"domain\": {\r\n      \"type\": String,\r\n      \"trim\": true,\r\n      \"required\" : true\r\n    },\r\n    \"mongoosemodelname\": {\r\n      \"type\": String,\r\n      \"trim\": true,\r\n      \"required\" : true\r\n    },\r\n    \"collectionname\": {\r\n      \"type\": String,\r\n      \"trim\": true,\r\n      \"required\" : true\r\n    },\r\n    \"props\" : {},\r\n    \"index\" : {}\r\n};\r\nconst ExtendedSchema_index = {\r\n    \"modelname\" : \"text\"\r\n};\r\n\r\n\r\n\r\n// load the models\r\n\r\nexport function loadModelNames(modelPath : string) : string[] {\r\n  modelPath = modelPath || envModelPath;\r\n  debuglog(()=> `modelpath is ${modelPath} `);\r\n  var mdls = FUtils.readFileAsJSON(modelPath + '/models.json');\r\n  mdls.forEach(name => {\r\n    if(name !== makeMongoCollectionName(name)) {\r\n        throw new Error('bad modelname, must terminate with s and be lowercase');\r\n    }\r\n  })\r\n  return mdls;\r\n}\r\n\r\nexport interface IRawSchema {\r\n    props: any[],\r\n    index : any\r\n}\r\n\r\n/*\r\nexport interface IModelDocCategoryRec {\r\n    category : string,\r\n    category_description : string,\r\n    QBEColumnProps : {\r\n        \"defaultWidth\": number,\r\n        \"QBE\": boolean,\r\n        \"LUNRIndex\": boolean\r\n      },\r\n      \"category_synonyms\": string[],\r\n    wordindex : boolean,\r\n    exactmatch: boolean,\r\n    showM\r\n};\r\n*/\r\n\r\nexport interface IModelDoc {\r\n    domain : string,\r\n    modelname? : string,\r\n    collectionname? : string,\r\n    domain_description : string\r\n    _categories : IMatch.IModelCategoryRec[],\r\n    columns: string[],\r\n    domain_synonyms : string[]\r\n\r\n}\r\n\r\nexport interface IExtendedSchema extends IRawSchema{\r\n    domain : string,\r\n    modelname : string,\r\n    mongoosemodelname : string,\r\n    collectionname : string\r\n};\r\n\r\nexport function mapType(val : string) : any {\r\n    if(val === \"String\") {\r\n        return String;\r\n    }\r\n    if(val === \"Boolean\") {\r\n        return Boolean;\r\n    }\r\n    if(val === \"Number\") {\r\n        return Number;\r\n    }\r\n    throw new Error(\" illegal type \" + val + \" expected String, Boolean, Number, ...\");\r\n}\r\n\r\nexport function replaceIfTypeDeleteM(obj : any, val : any, key : string) {\r\n    if(key.substr(0,3) === \"_m_\") {\r\n        delete obj[key];\r\n        return;\r\n    };\r\n    if(key === \"type\" && typeof val === \"string\") {\r\n        var r = mapType(val);\r\n        obj[key] = r;\r\n    }\r\n}\r\n\r\nfunction traverseExecuting(obj, fn ) {\r\n    _.forIn(obj, function (val, key) {\r\n    //    console.log(val + \" -> \" + key + \" \");\r\n        fn(obj,val,key);\r\n        if (_.isArray(val)) {\r\n            val.forEach(function(el) {\r\n                if (_.isObject(el)) {\r\n                    traverseExecuting(el,fn);\r\n                }\r\n            });\r\n        }\r\n        if (_.isObject(val)) {\r\n            traverseExecuting(obj[key],fn);\r\n        }\r\n    });\r\n}\r\n\r\nfunction traverseReplacingType(obj) {\r\n    return traverseExecuting(obj,replaceIfTypeDeleteM);\r\n    /*\r\n    _.forIn(obj, function (val, key) {\r\n    //    console.log(val + \" -> \" + key + \" \");\r\n        replaceIfTypeDeleteM(obj,val,key);\r\n        if (_.isArray(val)) {\r\n            val.forEach(function(el) {\r\n                if (_.isObject(el)) {\r\n                    traverseReplacingType(el);\r\n                }\r\n            });\r\n        }\r\n        if (_.isObject(val)) {\r\n            traverseReplacingType(obj[key]);\r\n        }\r\n    });\r\n    */\r\n}\r\n\r\nexport function typeProps(a : any) : any {\r\n   var aCloned = _.cloneDeep(a);\r\n   //console.log(JSON.stringify(aCloned, undefined, 2));\r\n   traverseReplacingType(aCloned);\r\n   return aCloned;\r\n}\r\n\r\nexport function makeMongooseSchema( extSchema : IExtendedSchema , mongo? : any) : mongoose.Schema {\r\n    var typedProps = typeProps(extSchema.props);\r\n    var mongo = mongo || mongoose;\r\n     var schema = mongo.Schema(extSchema.props); //{ props : extSchema.props, index : extSchema.index  });\r\n     schema.index(extSchema.index);\r\n     return schema;\r\n}\r\n\r\nexport function loadExtendedMongooseSchema(modelPath: string, modelName : string): IExtendedSchema {\r\n  var filename =  modelPath + '/' + modelName + '.model.mongooseschema.json';\r\n  debuglog(()=> `attempting to read ${filename}`)\r\n  var schemaSer = FUtils.readFileAsJSON(filename);\r\n  schemaSer.modelName = modelName;\r\n  return schemaSer;\r\n}\r\n\r\nexport function loadModelDoc(modelPath: string, modelName : string): IModelDoc {\r\n  var docSer = FUtils.readFileAsJSON( modelPath + '/' + modelName + '.model.doc.json');\r\n  docSer.modelname = modelName;\r\n  return docSer;\r\n}\r\n\r\nvar aPromise = global.Promise;\r\n\r\nexport interface IModelRec  {\r\n    collectionName : string,\r\n    model : mongoose.Model<any>,\r\n    schema : mongoose.Schema\r\n};\r\n\r\n\r\nexport function augmentMongooseSchema( modelDoc : IModelDoc, schemaRaw : IRawSchema) : IExtendedSchema {\r\n    debuglog( ()=>'augmenting for ' + modelDoc.modelname);\r\n    var res = { domain : modelDoc.domain,\r\n        modelname : modelDoc.modelname,\r\n        mongoosemodelname : makeMongooseModelName(modelDoc.modelname),\r\n        collectionname : makeMongoCollectionName(modelDoc.modelname)\r\n     } as IExtendedSchema;\r\n    return (Object as any).assign(res, schemaRaw);\r\n}\r\n\r\n/**\r\n * return a modelname\r\n * @param collectionName\r\n */\r\nexport function makeMongooseModelName(collectionName : string) : string {\r\n    if(collectionName !== collectionName.toLowerCase()) {\r\n        throw new Error('expect lowercase, was ' + collectionName);\r\n    }\r\n    if (collectionName.charAt(collectionName.length-1) === 's') {\r\n        return collectionName; // beware, ALTERED RECENTLY 28.08.2019\r\n        // return collectionName.substring(0,collectionName.length-1);\r\n    }\r\n    throw new Error('expected name with trailing s');\r\n}\r\n\r\n/**\r\n * returns a mongoose collection name\r\n * @param modelName\r\n */\r\nexport function makeMongoCollectionName(modelName : string) : string {\r\n    if(modelName !== modelName.toLowerCase()) {\r\n        throw new Error('expect lowercase, was ' + modelName);\r\n    }\r\n    if (modelName.charAt(modelName.length-1) !== 's') {\r\n        throw new Error(' expect trailing s:' + modelName );\r\n    }\r\n    if (modelName.charAt(modelName.length-1) !== 's') {\r\n        return modelName + 's';\r\n    }\r\n    return modelName;\r\n}\r\n\r\nexport function getExtendedSchema(mongoose : any) : mongoose.Schema {\r\n  var extendSchema = mongoose.Schema(ExtendedSchema_props);\r\n    //console.log(\"now extended schema\");\r\n    extendSchema.index(ExtendedSchema_index);\r\n    return extendSchema;\r\n    //console.log('creating model 2');\r\n}\r\n\r\nexport function getExtendedSchemaModel(mongoose : mongoose.Mongoose) : mongoose.Model<any> {\r\n    var mgModelName = makeMongooseModelName(MongoNLQ.COLL_EXTENDEDSCHEMAS)\r\n    if(mongoose.modelNames().indexOf(mgModelName) >= 0) {\r\n        return mongoose.model(mgModelName);\r\n    }\r\n    var extendSchema = getExtendedSchema(mongoose);\r\n    var modelES = mongoose.model(makeMongooseModelName(MongoNLQ.COLL_EXTENDEDSCHEMAS), extendSchema);\r\n    return modelES;\r\n}\r\n\r\n\r\nexport function getModelDocModel(mongoose : mongoose.Mongoose) : mongoose.Model<any> {\r\n    var metaDoc = FUtils.readFileAsJSON( __dirname + '/../../resources/meta/metamodels.model.doc.json');\r\n    metaDoc.modelname = MongoNLQ.MODELNAME_METAMODELS;\r\n    var schemaSer2 = loadExtendedMongooseSchema(__dirname + '/../../resources/meta',MongoNLQ.MODELNAME_METAMODELS);\r\n    var schemaSer = augmentMongooseSchema(metaDoc, schemaSer2);\r\n    var schema = makeMongooseSchema(schemaSer, mongoose);\r\n    var mongooseModelName = makeMongooseModelName(MongoNLQ.COLL_METAMODELS);\r\n    if (mongoose.modelNames().indexOf(mongooseModelName) >= 0) {\r\n        return mongoose.model(mongooseModelName);\r\n    }\r\n    var modelDoc = mongoose.model(makeMongooseModelName(MongoNLQ.COLL_METAMODELS), schema );\r\n    var oFind = modelDoc.find;\r\n     return modelDoc;\r\n}\r\n\r\nexport function upsertMetaModel(mongoose : any) {\r\n    debuglog(()=>'here dirname + ' + __dirname);\r\n    var metaDoc = FUtils.readFileAsJSON(__dirname + '/../../resources/meta/metamodels.model.doc.json');\r\n    debuglog( ()=> \"here metaDoc to insert as loaded\" + JSON.stringify(metaDoc));\r\n    metaDoc.modelname = MongoNLQ.MODELNAME_METAMODELS;\r\n    var schemaSer2 = loadExtendedMongooseSchema(__dirname + '/../../resources/meta',MongoNLQ.MODELNAME_METAMODELS);\r\n    var schemaSer = augmentMongooseSchema(metaDoc, schemaSer2);\r\n\r\n    debuglog( ()=>'here schemaser' + JSON.stringify(schemaSer,undefined,2));\r\n    (mongoose as any).Promise = global.Promise;\r\n    var schema = makeMongooseSchema(schemaSer, mongoose);\r\n    //console.log(\"make schema 1\");\r\n    //var extendSchema = mongoose.Schema(ExtendedSchema_props);\r\n    ///console.log(\"now extended schema\");\r\n    //extendSchema.index(ExtendedSchema_index);\r\n    //console.log(\"now document ...\" + JSON.stringify(extendSchema,undefined,2));\r\n    var modelDoc = mongoose.model(makeMongooseModelName(MongoNLQ.COLL_METAMODELS), schema );\r\n    //console.log('creating model 2');\r\n    var modelES = getExtendedSchemaModel(mongoose); //mongoose.model(makeMongooseModelName(MongoNLQ.COLL_EXTENDEDSCHEMAS), extendSchema);\r\n\r\n    debuglog( ()=> \"here metaDoc to insert\" + JSON.stringify(metaDoc));\r\n    debuglog( ()=>\"here schemaser to insert\" + JSON.stringify(schemaSer));\r\n    return Promise.all([\r\n        validateDocVsMongooseModel(modelDoc, metaDoc).then( ()=>\r\n            modelDoc.findOneAndUpdate( { modelname :  MongoNLQ.MODELNAME_METAMODELS}, metaDoc, {\r\n                upsert : true\r\n            })\r\n        ),\r\n        validateDocVsMongooseModel(modelES,schemaSer).then( ()=>\r\n            modelES.findOneAndUpdate( { modelname :  MongoNLQ.MODELNAME_METAMODELS}, schemaSer, {\r\n                upsert : true\r\n            })\r\n        )]); //.then( () => process.exit(-1));\r\n}\r\n\r\n\r\nexport function createDBWithModels(mongoose : mongoose.Mongoose , modelPath : string) : Promise<any> {\r\n    return upsertMetaModel(mongoose).then(\r\n        upsertModels.bind(undefined, mongoose, modelPath)\r\n    );\r\n}\r\n\r\n\r\n//export function getModelNames(model : mongoose.model, )\r\n\r\nexport function removeOthers(mongoose : any, model: mongoose.Model<any>, retainedNames : string[] ) : Promise<any> {\r\n    //console.log('here collectionname' + Object.keys(model));\r\n    //console.log('here collectionname' + model.collectionname);\r\n    return (model.aggregate([{$project : { modelname : 1 }}]) as any).then( (r) =>\r\n        r.map(o => (o as any).modelname as string)\r\n    ).then( (modelnames : any) => {\r\n        debuglog(\" present models \" + modelnames.length + ' ' + modelnames);\r\n        var delta = _.difference(modelnames, retainedNames);\r\n        debuglog(' spurious models: ' + delta.length + ' ' + delta);\r\n        if(delta.length === 0) {\r\n            return Promise.resolve(true);\r\n        }\r\n        return Promise.all(delta.map( modelname => (model.remove as any)({ modelname : modelname})));\r\n    });\r\n}\r\nvar SchemaOperators = { operators : {}, synonyms : {}};\r\n\r\nvar SchemaFillers = { fillers : [{\r\n    type : String\r\n}]\r\n};\r\n\r\nexport function getOrCreateModelFillers(mongoose: mongoose.Mongoose) : mongoose.Model<any> {\r\n    if(mongoose.modelNames().indexOf('fillers') >= 0) {\r\n        return mongoose.model('fillers');\r\n    } else {\r\n        return mongoose.model('fillers', new mongoose.Schema(SchemaFillers));\r\n    }\r\n}\r\n\r\nexport function getOrCreateModelOperators(mongoose: mongoose.Mongoose) : mongoose.Model<any> {\r\n    if(mongoose.modelNames().indexOf('operators') >= 0) {\r\n        return mongoose.model('operators');\r\n    } else {\r\n        return mongoose.model('operators', new mongoose.Schema(SchemaOperators));\r\n    }\r\n}\r\n\r\nexport function getFillersFromDB( mongoose : mongoose.Mongoose) : Promise<any> {\r\n    var fillerModel = getOrCreateModelFillers(mongoose);\r\n    return fillerModel.find({}).lean().exec().then( (vals : any[]) => {\r\n        if(vals.length !== 1) {\r\n            throw new Error('expected exactly one operators entry ');\r\n        };\r\n        return vals[0];\r\n    });\r\n}\r\n\r\n\r\nexport function getOperatorsFromDB( mongoose : mongoose.Mongoose) : Promise<any> {\r\n    var operatorModel = getOrCreateModelOperators(mongoose);\r\n    return operatorModel.find({}).lean().exec().then( (vals : any[]) => {\r\n        if(vals.length !== 1) {\r\n            throw new Error('expected exactly one operators entry ');\r\n        };\r\n        return vals[0];\r\n    });\r\n}\r\n\r\nexport function getExtendSchemaDocFromDB(mongoose : mongoose.Mongoose, modelName : string) : Promise<IExtendedSchema> {\r\n    var mongooseModelName = makeMongooseModelName(modelName);\r\n    var model_ES = mongoose.model(MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n    var res = model_ES.find({ modelname : modelName}).lean().exec().then((doc) =>\r\n    {   debuglog( ()=> ` loaded Es doc ${modelName} returned ${(doc as any).length} docus from db : `\r\n        + (doc as any)[0].modelname + `` + (doc as any)[0].collectionname );\r\n        debuglog(() => 'here the result' + JSON.stringify(doc));\r\n        if((doc as any).length === 0) {\r\n            throw Error('Model ' + modelName + ' is not present in ' + MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n        }\r\n        return doc[0];\r\n    });\r\n    //console.log('res' + typeof res);\r\n    return res;\r\n //   return Promise.reject('model ' + modelName + ' cannot be found on db');\r\n}\r\n\r\n\r\nexport function getModelDocFromDB(mongoose : mongoose.Mongoose, modelName : string) : Promise<IModelDoc> {\r\n    var mongooseModelName = makeMongooseModelName(modelName);\r\n    var model_ES = mongoose.model(MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n    return makeModelFromDB(mongoose, MongoNLQ.MODELNAME_METAMODELS).then(\r\n        (model) => model.find({ modelname : modelName}).lean().exec()\r\n    ).then((doc) =>\r\n        {\r\n            debuglog( ()=> ' loaded Model doc ${modelName} returned ${(doc as any).length} docus from db : '\r\n            + (doc as any)[0].modelname + ` ` + (doc as any)[0].collectionname );\r\n            debuglog('here the result' + JSON.stringify(doc));\r\n            if((doc as any).length === 0) {\r\n                throw Error('Model ' + modelName + ' is not present in ' + MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n            }\r\n            return doc[0];\r\n        }\r\n    );\r\n //   return Promise.reject('model ' + modelName + ' cannot be found on db');\r\n}\r\n\r\nexport function makeModelFromDB(mongoose : mongoose.Mongoose, modelName : string) : Promise<mongoose.Model<any>> {\r\n    var mongooseModelName = makeMongooseModelName(modelName);\r\n    if(mongoose.modelNames().indexOf(mongooseModelName) >= 0) {\r\n        return Promise.resolve(mongoose.model(mongooseModelName));\r\n    }\r\n    debuglog( ()=>'here present modelnames: ' + mongoose.modelNames().join('\\n'));\r\n    var model_ES = mongoose.model(MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n    debuglog( ()=>'here modelname:' + modelName);\r\n    var res = model_ES.find({ modelname : modelName}).lean().exec().then((doc) =>\r\n    {  debuglog( ()=>` loaded Model doc ${modelName} returned ${(doc as any).length} docus from db : `\r\n            + (doc as any)[0].modelname + ` ` + (doc as any)[0].collectionname );\r\n        debuglog( ()=>'here the result' + JSON.stringify(doc));\r\n        if((doc as any).length === 0) {\r\n            throw Error('Model ' + modelName + ' is not present in ' + MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n        }\r\n        debuglog(()=> 'creating schema for ' + modelName + ' from ');\r\n        //  + JSON.stringify(doc[0]));\r\n\r\n        var schema = makeMongooseSchema(doc[0] as IExtendedSchema,mongoose);\r\n        if(mongoose.modelNames().indexOf(mongooseModelName) >= 0) {\r\n            return Promise.resolve(mongoose.model(mongooseModelName));\r\n        }\r\n        console.log(' moongooseModelName : ' + mongooseModelName + ' ' + modelName );\r\n        var model = mongoose.model(mongooseModelName, schema);\r\n        debuglog( ()=> 'returning model: ' + modelName + ` `+ typeof model);\r\n        return Promise.resolve(model);\r\n    });\r\n    //console.log('res' + typeof res);\r\n    return res;\r\n //   return Promise.reject('model ' + modelName + ' cannot be found on db');\r\n}\r\n\r\nexport function uploadFillers(mongoose: mongoose.Mongoose, modelPath: string) : Promise<any> {\r\n    var modelFiller = getOrCreateModelFillers(mongoose);\r\n    return modelFiller.remove({}).then(() => {\r\n    var fillers = FUtils.readFileAsJSON(modelPath + '/filler.json');\r\n        return new modelFiller({ fillers: fillers}).save();\r\n    });\r\n}\r\nexport function uploadOperators(mongoose: mongoose.Mongoose, modelPath: string) : Promise<any> {\r\n    var modelFiller = getOrCreateModelOperators(mongoose);\r\n    return modelFiller.remove({}).then(() => {\r\n    var operators = FUtils.readFileAsJSON(modelPath + '/operators.json');\r\n    return new modelFiller(operators).save();\r\n    });\r\n}\r\n\r\n/**\r\n * Uploads the complete model (metadata!) information\r\n * Assumes metamodel has been loaded (see #upsertMetaModels)\r\n * @param mongoose {mongoose.Mongoose} the mongoose handle\r\n * @param modelpath {string}  the model path\r\n * @return Promise<any> the  promise\r\n */\r\nexport function upsertModels(mongoose : mongoose.Mongoose, modelpath: string)  : Promise<any> {\r\n    debuglog(()=> `modelpath ${modelpath} `);\r\n    var modelNames = loadModelNames(modelpath);\r\n    var model_ES = mongoose.model(MongooseNLQ.MONGOOSE_MODELNAME_EXTENDEDSCHEMAS);\r\n    var model_Doc = mongoose.model(MongooseNLQ.MONGOOSE_MODELNAME_METAMODELS);\r\n    debuglog('here modelnames ' + modelNames);\r\n    return removeOthers(mongoose, model_ES, [MongoNLQ.MODELNAME_METAMODELS] ).then( ()=>\r\n        Promise.all(modelNames.map( (modelName) => {\r\n            debuglog('upserting  ' + modelName);\r\n            var modelDoc = loadModelDoc(modelpath, modelName);\r\n            var schemaSer = loadExtendedMongooseSchema(modelpath, modelName);\r\n            var schemaFull = augmentMongooseSchema(modelDoc, schemaSer);\r\n            debuglog(`upserting eschema ${modelName}  with modelDoc` + JSON.stringify(schemaFull));\r\n            var p1 = model_ES.findOneAndUpdate( { modelname : modelName }, schemaFull, {\r\n                upsert : true\r\n            });\r\n            debuglog(`upserting model ${modelName}  with modelDoc` + JSON.stringify(modelDoc));\r\n            var p2 = model_Doc.findOneAndUpdate( { modelname : modelName }, modelDoc, {\r\n                upsert : true\r\n            });\r\n            return Promise.all([p1,p2]);\r\n        })\r\n        )\r\n    ).then( () => {\r\n        var modelNamesExtended = modelNames.slice();\r\n        modelNamesExtended.push(MongoNLQ.MODELNAME_METAMODELS);\r\n        debuglog('removing spurious models');\r\n        return Promise.all([\r\n            removeOthers(mongoose, model_ES, modelNamesExtended ),\r\n            removeOthers(mongoose, model_Doc, modelNamesExtended )\r\n        ]);\r\n    }).then( () => {\r\n         return Promise.all([\r\n            uploadFillers(mongoose,modelpath),\r\n            uploadOperators(mongoose, modelpath)\r\n         ])\r\n    })\r\n}\r\n\r\nexport function hasMetaCollection(mongoose : any) : Promise<boolean> {\r\n    return new Promise(function(resolve, reject) {\r\n        mongoose.connection.db.listCollections().toArray((err ,names ) =>\r\n        {\r\n            if(err) {\r\n                reject(err);\r\n                return;\r\n            }\r\n            if(names.indexOf(MongoNLQ.COLL_METAMODELS) >= 0) {\r\n                resolve(true);\r\n            }\r\n            reject(\"domain not loaded\");\r\n        });\r\n    });\r\n}\r\n\r\nexport const MongoNLQ = {\r\n    MODELNAME_METAMODELS : \"metamodels\",\r\n    COLL_METAMODELS : \"metamodels\",\r\n    COLL_EXTENDEDSCHEMAS : \"mongonlq_eschemas\"\r\n};\r\n\r\n\r\nexport const MongooseNLQ = {\r\n    MONGOOSE_MODELNAME_EXTENDEDSCHEMAS : makeMongooseModelName(MongoNLQ.COLL_EXTENDEDSCHEMAS),\r\n    MONGOOSE_MODELNAME_METAMODELS : makeMongooseModelName(MongoNLQ.COLL_METAMODELS)\r\n};\r\n/*\r\nexport function getModelRecByModelName(mongoose : any, modelPath: string, modelName : string) : Promise<IModelRec>  {\r\n    // do we have the meta collection in the db?\r\n    return Promise.all([\r\n        mongoose.connection.db[MongoNLQ.COLL_METAMODELS].find({ modelName : modelName}),\r\n        mongoose.connection.db[MongoNLQ.COLL_EXTENDEDSCHEMAS].find({ modelName : modelName})\r\n    ]).then(res => {\r\n        var modelDoc = res[0];\r\n        var extendedSchema = res[1];\r\n        var schema = makeMongooseSchema(extendedSchema);\r\n        var model = mongoose.model(modelDoc.collectionName, schema);\r\n        return {\r\n            collectionName : modelDoc.collectionName,\r\n            modelDoc : modelDoc,\r\n            schema : makeMongooseSchema(extendedSchema),\r\n            model : model\r\n        } as IModelRec;\r\n    });\r\n}\r\n*/\r\n\r\n/*\r\n    hasMetaCollection(mongoose).then( () => {\r\n        mongoose.connection.db.mgnlq_domains.find( {\r\n            modelName : modelName\r\n        }).then( doc => {\r\n            if (doc.schema)\r\n        });\r\n    });\r\n    mongoose.connection.db.listCollections().toArray((err ,names ) =>\r\n    {\r\n        if(names.indexOf(\"mgnlq_domains\") >= 0) {\r\n\r\n        }\r\n    });\r\n}\r\n*/\r\n\r\n\r\nexport function validateDocMongoose(mongoose : mongoose.Mongoose, collectionname, schema : mongoose.Schema, doc : any ) {\r\n    var DocModel;\r\n    //console.log('schema ' + JSON.stringify(schema));\r\n    if(mongoose.modelNames().indexOf(collectionname) >= 0) {\r\n        DocModel = mongoose.model(collectionname);\r\n    } else {\r\n        DocModel = mongoose.model(collectionname, schema);\r\n\r\n    }\r\n    return validateDocVsMongooseModel(DocModel, doc);\r\n}\r\n\r\nexport function validateDocVsMongooseModel(model, doc : any) {\r\n    return new Promise<any>((resolve,reject) => {\r\n        var theDoc = new model(doc);\r\n        theDoc.validate((err) =>  {\r\n            if (err) {\r\n                //console.log(err);\r\n                reject(err);\r\n            }\r\n        else {\r\n            resolve(theDoc);\r\n        }\r\n        });\r\n    });\r\n}\r\n\r\nexport function validateDoc(collectionname: string, schema : mongoose.Schema, doc : any) {\r\n  var jsonSchemaR = (schema as any).jsonSchema();\r\n  var jsonSchema = _.cloneDeep(jsonSchemaR);\r\n  traverseExecuting(jsonSchema, function(obj,val,key) {\r\n    if(key === 'properties' && obj.type === 'object') {\r\n        //console.log('augmenting schema');\r\n        obj.additionalProperties = false;\r\n    }\r\n  });\r\n\r\n  debuglog(()=> ` here json schema ` + (JSON.stringify(jsonSchema,undefined,2)));\r\n  var Validator = require('jsonschema').Validator;\r\n  var v = new Validator();\r\n  //console.log(JSON.stringify(jsonSchema,undefined,2));\r\n  var valresult = v.validate(doc,jsonSchema);\r\n  if(valresult.errors.length) {\r\n      throw new Error(\"Schema validating against JSON Schema failed : \" + JSON.stringify(valresult.errors,undefined,2));\r\n  }\r\n  return true;\r\n}"],"sourceRoot":"ABC"}