{"version":3,"sources":["/projects/nodejs/botbuilder/mgnlq_model//projects/nodejs/botbuilder/mgnlq_model/src/../src/modelload/dataload.ts"],"names":[],"mappings":"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","file":"dataload.js","sourcesContent":["/**\r\n * Functionality to load data into a mongoose model\r\n * (c) gerd forstmann 2017\r\n *\r\n * @file\r\n */\r\n\r\n//import * as intf from 'constants';\r\nimport * as debug from 'debugf';\r\n\r\nvar debuglog = debug('model');\r\n\r\n//const loadlog = logger.logger('modelload', '');\r\n\r\nimport *  as IMatch from '../match/ifmatch';\r\n//import * as InputFilterRules from '../match/rule';\r\n//import * as Tools from '../match/tools';\r\nimport * as fs from 'fs';\r\nimport * as Meta from '../model/meta';\r\nimport * as FUtils from '../model/model';\r\nimport * as Utils from 'abot_utils';\r\n//import * as CircularSer from 'abot_utils';\r\n//import * as Distance from 'abot_stringdist';\r\nimport * as process from 'process';\r\nimport * as _ from 'lodash';\r\n//import {Mongoose as Mongoose} from 'mongoose';\r\nimport * as mongoose from 'mongoose';\r\n(mongoose as any).Promise = global.Promise;\r\n/**\r\n * WATCH out, this instruments mongoose!\r\n */\r\nrequire('mongoose-schema-jsonschema')(mongoose);\r\n/**\r\n * the model path, may be controlled via environment variable\r\n */\r\n//var envModelPath = process.env[\"ABOT_MODELPATH\"] || \"node_modules/abot_testmodel/testmodel\";\r\n\r\nexport function cmpTools(a: IMatch.ITool, b: IMatch.ITool) {\r\n  return a.name.localeCompare(b.name);\r\n}\r\n\r\ntype IModel = IMatch.IModel;\r\n\r\n// load the models\r\n\r\nimport * as Model from '../model/model';\r\n\r\nimport * as SchemaLoad from  './schemaload';\r\n\r\nimport * as MongoUtils from '../utils/mongo';\r\n\r\n/**\r\n * Create Database (currently does not drop database before!)\r\n * @param mongoose {mongoose.Mongoose} mongoose instance ( or mock for testing)\r\n * @param mongoConnectionString {string}  connectionstring, method will connect and disconnect\r\n * (currenlty disconnnect only on success, subject to change)\r\n * @param modelPath {string} modepath to read data from\r\n */\r\nexport function createDB(mongoose : mongoose.Mongoose, mongoConnectionString : string, modelPath: string) : Promise<any> {\r\n    if(modelPath[modelPath.length-1] === \"\\\\\" || modelPath[modelPath.length-1] === \"/\")  {\r\n        throw new Error(`modelpath should be w.o. trailing \"/\" or \"\\\\\", was ${modelPath} `);\r\n    }\r\n /**\r\n * WATCH out, this instruments mongoose!\r\n */\r\n    require('mongoose-schema-jsonschema')(mongoose);\r\n\r\n    return MongoUtils.openMongoose(mongoose, mongoConnectionString).then( () =>\r\n        SchemaLoad.createDBWithModels(mongoose, modelPath)\r\n    ).then( ()=> {\r\n        var models = SchemaLoad.loadModelNames(modelPath);\r\n\r\n\r\n        return Promise.all(models.map(modelName => loadModelData(mongoose,modelPath, modelName)));\r\n    }).then( () => {\r\n        MongoUtils.disconnectReset(mongoose);\r\n    });\r\n}\r\n\r\n\r\nexport function getModel(mongoose: any, modelName: string, modelPath: string) : Promise<mongoose.Model<any>> {\r\n   if(mongoose.models[modelName]) {\r\n       console.log(` got model for ${modelName} `);\r\n       return Promise.resolve(mongoose.models[modelName]);\r\n   }\r\n   console.log(` no model found for ${modelName} `);\r\n   var Eschema = mongoose.models['mongonlq_eschemas'];\r\n   if(!Eschema) {\r\n       throw new Error('this database does not have an eschema model initialized');\r\n   }\r\n   return SchemaLoad.makeModelFromDB(mongoose, modelName);\r\n}\r\n\r\nexport function loadModelData(mongoose : any,  modelPath: string, modelName : string ) {\r\n    var data = FUtils.readFileAsJSON( modelPath + '/' + modelName + '.data.json');\r\n    var cnt = 0;\r\n    // load the schema, either from database or from file system\r\n    return getModel(mongoose, modelName, modelPath).then(oModel =>{\r\n        console.log('** got a model to load: ' + oModel.modelName);\r\n        return Promise.all(data.map( (oRecord,index) => {\r\n            try {\r\n                return SchemaLoad.validateDoc(oModel.modelName, oModel.schema, oRecord);\r\n            } catch(err) {\r\n                console.log('error validation object ' + modelName + ' record #' + index);\r\n                throw err;\r\n            }\r\n        })).then( () => { return oModel;}\r\n        )\r\n    }).then( oModel2 => {\r\n        return Promise.all(data.map( (oRecord,index) => SchemaLoad.validateDocMongoose(mongoose, oModel2.modelName, oModel2.schema, oRecord))).then( () => { return oModel2;})\r\n    }).then( (oModel) => {\r\n        return oModel.remove({}).then(() => oModel)\r\n        .then( oModel => {\r\n            return Promise.all(data.map(doc => {\r\n              var oDoc = new oModel(doc);\r\n                return oDoc.save().then( a => { ++cnt; }).catch(err => console.log(\"error inserting \" + err + \"  inserting : \" + JSON.stringify(doc) + \"\" ));\r\n            }));\r\n         }).then(() => oModel );\r\n    }).then(oModel => {\r\n        console.log(`inserted ${cnt} documents for domain ${modelName}`);\r\n    }).catch(err => {\r\n        console.log(`error inserting documents for domain ${modelName}\\n` + err + err.stack);\r\n    });\r\n}\r\n\r\n(<any>mongoose).Promise = global.Promise;\r\n\r\n\r\nfunction deleteAll(model : mongoose.Model<any>) {\r\n  return model.collection.drop();\r\n}"],"sourceRoot":"ABC"}