"use strict";
/**
 * Functionality to load data into a mongoose model
 * (c) gerd forstmann 2017
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadModelData = exports.getModel = exports.createDB = exports.cmpTools = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('model');
const FUtils = require("../model/model");
//import {Mongoose as Mongoose} from 'mongoose';
const mongoose = require("mongoose");
mongoose.Promise = global.Promise;
/**
 * WATCH out, this instruments mongoose!
 */
require('mongoose-schema-jsonschema')(mongoose);
/**
 * the model path, may be controlled via environment variable
 */
//var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function cmpTools(a, b) {
    return a.name.localeCompare(b.name);
}
exports.cmpTools = cmpTools;
const SchemaLoad = require("./schemaload");
const MongoUtils = require("../utils/mongo");
/**
 * Create Database (currently does not drop database before!)
 * @param mongoose {mongoose.Mongoose} mongoose instance ( or mock for testing)
 * @param mongoConnectionString {string}  connectionstring, method will connect and disconnect
 * (currenlty disconnnect only on success, subject to change)
 * @param modelPath {string} modepath to read data from
 */
function createDB(mongoose, mongoConnectionString, modelPath) {
    if (modelPath[modelPath.length - 1] === "\\" || modelPath[modelPath.length - 1] === "/") {
        throw new Error(`modelpath should be w.o. trailing "/" or "\\", was ${modelPath} `);
    }
    /**
    * WATCH out, this instruments mongoose!
    */
    require('mongoose-schema-jsonschema')(mongoose);
    return MongoUtils.openMongoose(mongoose, mongoConnectionString).then(() => SchemaLoad.createDBWithModels(mongoose, modelPath)).then(() => {
        var models = SchemaLoad.loadModelNames(modelPath);
        return Promise.all(models.map(modelName => loadModelData(mongoose, modelPath, modelName)));
    }).then(() => {
        MongoUtils.disconnectReset(mongoose);
    });
}
exports.createDB = createDB;
function getModel(mongoose, modelName, modelPath) {
    if (mongoose.models[modelName]) {
        console.log(` got model for ${modelName} `);
        return Promise.resolve(mongoose.models[modelName]);
    }
    console.log(` no model found for ${modelName} `);
    var Eschema = mongoose.models['mongonlq_eschemas'];
    if (!Eschema) {
        throw new Error('this database does not have an eschema model initialized');
    }
    return SchemaLoad.makeModelFromDB(mongoose, modelName);
}
exports.getModel = getModel;
function loadModelData(mongoose, modelPath, modelName) {
    var data = FUtils.readFileAsJSON(modelPath + '/' + modelName + '.data.json');
    var cnt = 0;
    // load the schema, either from database or from file system
    return getModel(mongoose, modelName, modelPath).then(oModel => {
        console.log('** got a model to load: ' + oModel.modelName);
        return Promise.all(data.map((oRecord, index) => {
            try {
                return SchemaLoad.validateDoc(oModel.modelName, oModel.schema, oRecord);
            }
            catch (err) {
                console.log('error validation object ' + modelName + ' record #' + index);
                throw err;
            }
        })).then(() => { return oModel; });
    }).then(oModel2 => {
        return Promise.all(data.map((oRecord, index) => SchemaLoad.validateDocMongoose(mongoose, oModel2.modelName, oModel2.schema, oRecord))).then(() => { return oModel2; });
    }).then((oModel) => {
        return oModel.remove({}).then(() => oModel)
            .then(oModel => {
            return Promise.all(data.map(doc => {
                var oDoc = new oModel(doc);
                return oDoc.save().then(a => { ++cnt; }).catch(err => console.log("error inserting " + err + "  inserting : " + JSON.stringify(doc) + ""));
            }));
        }).then(() => oModel);
    }).then(oModel => {
        console.log(`inserted ${cnt} documents for domain ${modelName}`);
    }).catch(err => {
        console.log(`error inserting documents for domain ${modelName}\n` + err + err.stack);
    });
}
exports.loadModelData = loadModelData;
mongoose.Promise = global.Promise;
function deleteAll(model) {
    return model.collection.drop();
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbGxvYWQvZGF0YWxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFFSCxvQ0FBb0M7QUFDcEMsZ0NBQWdDO0FBRWhDLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztBQVM5Qix5Q0FBeUM7QUFNekMsZ0RBQWdEO0FBQ2hELHFDQUFxQztBQUNwQyxRQUFnQixDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO0FBQzNDOztHQUVHO0FBQ0gsT0FBTyxDQUFDLDRCQUE0QixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDaEQ7O0dBRUc7QUFDSCw4RkFBOEY7QUFFOUYsU0FBZ0IsUUFBUSxDQUFDLENBQWUsRUFBRSxDQUFlO0lBQ3ZELE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFGRCw0QkFFQztBQVFELDJDQUE0QztBQUU1Qyw2Q0FBNkM7QUFFN0M7Ozs7OztHQU1HO0FBQ0gsU0FBZ0IsUUFBUSxDQUFDLFFBQTRCLEVBQUUscUJBQThCLEVBQUUsU0FBaUI7SUFDcEcsSUFBRyxTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFHO1FBQ2pGLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDdkY7SUFDSjs7TUFFRTtJQUNDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRWhELE9BQU8sVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUUsR0FBRyxFQUFFLENBQ3ZFLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxRQUFR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QUFDUCxDQUFDO0FBOUJELHNDQThCQztBQUVLLFFBQVMsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUd6QyxTQUFTLFNBQVMsQ0FBQyxLQUEyQjtJQUM1QyxPQUFPLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDakMsQ0FBQyIsImZpbGUiOiJtb2RlbGxvYWQvZGF0YWxvYWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSB0byBsb2FkIGRhdGEgaW50byBhIG1vbmdvb3NlIG1vZGVsXHJcbiAqIChjKSBnZXJkIGZvcnN0bWFubiAyMDE3XHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuLy9pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnZic7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcclxuXHJcbi8vY29uc3QgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcclxuXHJcbmltcG9ydCAqICBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcbi8vaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9ydWxlJztcclxuLy9pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgTWV0YSBmcm9tICcuLi9tb2RlbC9tZXRhJztcclxuaW1wb3J0ICogYXMgRlV0aWxzIGZyb20gJy4uL21vZGVsL21vZGVsJztcclxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnYWJvdF91dGlscyc7XHJcbi8vaW1wb3J0ICogYXMgQ2lyY3VsYXJTZXIgZnJvbSAnYWJvdF91dGlscyc7XHJcbi8vaW1wb3J0ICogYXMgRGlzdGFuY2UgZnJvbSAnYWJvdF9zdHJpbmdkaXN0JztcclxuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG4vL2ltcG9ydCB7TW9uZ29vc2UgYXMgTW9uZ29vc2V9IGZyb20gJ21vbmdvb3NlJztcclxuaW1wb3J0ICogYXMgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xyXG4obW9uZ29vc2UgYXMgYW55KS5Qcm9taXNlID0gZ2xvYmFsLlByb21pc2U7XHJcbi8qKlxyXG4gKiBXQVRDSCBvdXQsIHRoaXMgaW5zdHJ1bWVudHMgbW9uZ29vc2UhXHJcbiAqL1xyXG5yZXF1aXJlKCdtb25nb29zZS1zY2hlbWEtanNvbnNjaGVtYScpKG1vbmdvb3NlKTtcclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbi8vdmFyIGVudk1vZGVsUGF0aCA9IHByb2Nlc3MuZW52W1wiQUJPVF9NT0RFTFBBVEhcIl0gfHwgXCJub2RlX21vZHVsZXMvYWJvdF90ZXN0bW9kZWwvdGVzdG1vZGVsXCI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY21wVG9vbHMoYTogSU1hdGNoLklUb29sLCBiOiBJTWF0Y2guSVRvb2wpIHtcclxuICByZXR1cm4gYS5uYW1lLmxvY2FsZUNvbXBhcmUoYi5uYW1lKTtcclxufVxyXG5cclxudHlwZSBJTW9kZWwgPSBJTWF0Y2guSU1vZGVsO1xyXG5cclxuLy8gbG9hZCB0aGUgbW9kZWxzXHJcblxyXG5pbXBvcnQgKiBhcyBNb2RlbCBmcm9tICcuLi9tb2RlbC9tb2RlbCc7XHJcblxyXG5pbXBvcnQgKiBhcyBTY2hlbWFMb2FkIGZyb20gICcuL3NjaGVtYWxvYWQnO1xyXG5cclxuaW1wb3J0ICogYXMgTW9uZ29VdGlscyBmcm9tICcuLi91dGlscy9tb25nbyc7XHJcblxyXG4vKipcclxuICogQ3JlYXRlIERhdGFiYXNlIChjdXJyZW50bHkgZG9lcyBub3QgZHJvcCBkYXRhYmFzZSBiZWZvcmUhKVxyXG4gKiBAcGFyYW0gbW9uZ29vc2Uge21vbmdvb3NlLk1vbmdvb3NlfSBtb25nb29zZSBpbnN0YW5jZSAoIG9yIG1vY2sgZm9yIHRlc3RpbmcpXHJcbiAqIEBwYXJhbSBtb25nb0Nvbm5lY3Rpb25TdHJpbmcge3N0cmluZ30gIGNvbm5lY3Rpb25zdHJpbmcsIG1ldGhvZCB3aWxsIGNvbm5lY3QgYW5kIGRpc2Nvbm5lY3RcclxuICogKGN1cnJlbmx0eSBkaXNjb25ubmVjdCBvbmx5IG9uIHN1Y2Nlc3MsIHN1YmplY3QgdG8gY2hhbmdlKVxyXG4gKiBAcGFyYW0gbW9kZWxQYXRoIHtzdHJpbmd9IG1vZGVwYXRoIHRvIHJlYWQgZGF0YSBmcm9tXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlREIobW9uZ29vc2UgOiBtb25nb29zZS5Nb25nb29zZSwgbW9uZ29Db25uZWN0aW9uU3RyaW5nIDogc3RyaW5nLCBtb2RlbFBhdGg6IHN0cmluZykgOiBQcm9taXNlPGFueT4ge1xyXG4gICAgaWYobW9kZWxQYXRoW21vZGVsUGF0aC5sZW5ndGgtMV0gPT09IFwiXFxcXFwiIHx8IG1vZGVsUGF0aFttb2RlbFBhdGgubGVuZ3RoLTFdID09PSBcIi9cIikgIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG1vZGVscGF0aCBzaG91bGQgYmUgdy5vLiB0cmFpbGluZyBcIi9cIiBvciBcIlxcXFxcIiwgd2FzICR7bW9kZWxQYXRofSBgKTtcclxuICAgIH1cclxuIC8qKlxyXG4gKiBXQVRDSCBvdXQsIHRoaXMgaW5zdHJ1bWVudHMgbW9uZ29vc2UhXHJcbiAqL1xyXG4gICAgcmVxdWlyZSgnbW9uZ29vc2Utc2NoZW1hLWpzb25zY2hlbWEnKShtb25nb29zZSk7XHJcblxyXG4gICAgcmV0dXJuIE1vbmdvVXRpbHMub3Blbk1vbmdvb3NlKG1vbmdvb3NlLCBtb25nb0Nvbm5lY3Rpb25TdHJpbmcpLnRoZW4oICgpID0+XHJcbiAgICAgICAgU2NoZW1hTG9hZC5jcmVhdGVEQldpdGhNb2RlbHMobW9uZ29vc2UsIG1vZGVsUGF0aClcclxuICAgICkudGhlbiggKCk9PiB7XHJcbiAgICAgICAgdmFyIG1vZGVscyA9IFNjaGVtYUxvYWQubG9hZE1vZGVsTmFtZXMobW9kZWxQYXRoKTtcclxuXHJcblxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChtb2RlbHMubWFwKG1vZGVsTmFtZSA9PiBsb2FkTW9kZWxEYXRhKG1vbmdvb3NlLG1vZGVsUGF0aCwgbW9kZWxOYW1lKSkpO1xyXG4gICAgfSkudGhlbiggKCkgPT4ge1xyXG4gICAgICAgIE1vbmdvVXRpbHMuZGlzY29ubmVjdFJlc2V0KG1vbmdvb3NlKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vZGVsKG1vbmdvb3NlOiBhbnksIG1vZGVsTmFtZTogc3RyaW5nLCBtb2RlbFBhdGg6IHN0cmluZykgOiBQcm9taXNlPG1vbmdvb3NlLk1vZGVsPGFueT4+IHtcclxuICAgaWYobW9uZ29vc2UubW9kZWxzW21vZGVsTmFtZV0pIHtcclxuICAgICAgIGNvbnNvbGUubG9nKGAgZ290IG1vZGVsIGZvciAke21vZGVsTmFtZX0gYCk7XHJcbiAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1vbmdvb3NlLm1vZGVsc1ttb2RlbE5hbWVdKTtcclxuICAgfVxyXG4gICBjb25zb2xlLmxvZyhgIG5vIG1vZGVsIGZvdW5kIGZvciAke21vZGVsTmFtZX0gYCk7XHJcbiAgIHZhciBFc2NoZW1hID0gbW9uZ29vc2UubW9kZWxzWydtb25nb25scV9lc2NoZW1hcyddO1xyXG4gICBpZighRXNjaGVtYSkge1xyXG4gICAgICAgdGhyb3cgbmV3IEVycm9yKCd0aGlzIGRhdGFiYXNlIGRvZXMgbm90IGhhdmUgYW4gZXNjaGVtYSBtb2RlbCBpbml0aWFsaXplZCcpO1xyXG4gICB9XHJcbiAgIHJldHVybiBTY2hlbWFMb2FkLm1ha2VNb2RlbEZyb21EQihtb25nb29zZSwgbW9kZWxOYW1lKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2RlbERhdGEobW9uZ29vc2UgOiBhbnksICBtb2RlbFBhdGg6IHN0cmluZywgbW9kZWxOYW1lIDogc3RyaW5nICkge1xyXG4gICAgdmFyIGRhdGEgPSBGVXRpbHMucmVhZEZpbGVBc0pTT04oIG1vZGVsUGF0aCArICcvJyArIG1vZGVsTmFtZSArICcuZGF0YS5qc29uJyk7XHJcbiAgICB2YXIgY250ID0gMDtcclxuICAgIC8vIGxvYWQgdGhlIHNjaGVtYSwgZWl0aGVyIGZyb20gZGF0YWJhc2Ugb3IgZnJvbSBmaWxlIHN5c3RlbVxyXG4gICAgcmV0dXJuIGdldE1vZGVsKG1vbmdvb3NlLCBtb2RlbE5hbWUsIG1vZGVsUGF0aCkudGhlbihvTW9kZWwgPT57XHJcbiAgICAgICAgY29uc29sZS5sb2coJyoqIGdvdCBhIG1vZGVsIHRvIGxvYWQ6ICcgKyBvTW9kZWwubW9kZWxOYW1lKTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGF0YS5tYXAoIChvUmVjb3JkLGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZW1hTG9hZC52YWxpZGF0ZURvYyhvTW9kZWwubW9kZWxOYW1lLCBvTW9kZWwuc2NoZW1hLCBvUmVjb3JkKTtcclxuICAgICAgICAgICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciB2YWxpZGF0aW9uIG9iamVjdCAnICsgbW9kZWxOYW1lICsgJyByZWNvcmQgIycgKyBpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSkudGhlbiggKCkgPT4geyByZXR1cm4gb01vZGVsO31cclxuICAgICAgICApXHJcbiAgICB9KS50aGVuKCBvTW9kZWwyID0+IHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGF0YS5tYXAoIChvUmVjb3JkLGluZGV4KSA9PiBTY2hlbWFMb2FkLnZhbGlkYXRlRG9jTW9uZ29vc2UobW9uZ29vc2UsIG9Nb2RlbDIubW9kZWxOYW1lLCBvTW9kZWwyLnNjaGVtYSwgb1JlY29yZCkpKS50aGVuKCAoKSA9PiB7IHJldHVybiBvTW9kZWwyO30pXHJcbiAgICB9KS50aGVuKCAob01vZGVsKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5yZW1vdmUoe30pLnRoZW4oKCkgPT4gb01vZGVsKVxyXG4gICAgICAgIC50aGVuKCBvTW9kZWwgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGF0YS5tYXAoZG9jID0+IHtcclxuICAgICAgICAgICAgICB2YXIgb0RvYyA9IG5ldyBvTW9kZWwoZG9jKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvRG9jLnNhdmUoKS50aGVuKCBhID0+IHsgKytjbnQ7IH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhcImVycm9yIGluc2VydGluZyBcIiArIGVyciArIFwiICBpbnNlcnRpbmcgOiBcIiArIEpTT04uc3RyaW5naWZ5KGRvYykgKyBcIlwiICkpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgIH0pLnRoZW4oKCkgPT4gb01vZGVsICk7XHJcbiAgICB9KS50aGVuKG9Nb2RlbCA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGluc2VydGVkICR7Y250fSBkb2N1bWVudHMgZm9yIGRvbWFpbiAke21vZGVsTmFtZX1gKTtcclxuICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGVycm9yIGluc2VydGluZyBkb2N1bWVudHMgZm9yIGRvbWFpbiAke21vZGVsTmFtZX1cXG5gICsgZXJyICsgZXJyLnN0YWNrKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4oPGFueT5tb25nb29zZSkuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xyXG5cclxuXHJcbmZ1bmN0aW9uIGRlbGV0ZUFsbChtb2RlbCA6IG1vbmdvb3NlLk1vZGVsPGFueT4pIHtcclxuICByZXR1cm4gbW9kZWwuY29sbGVjdGlvbi5kcm9wKCk7XHJcbn0iXX0=
